@model int
@{
    ViewData["Title"] = "Phân công phản biện";
    var availableReviewers = ViewBag.AvailableReviewers as List<SciSubmit.Models.Admin.ReviewerViewModel> ?? new List<SciSubmit.Models.Admin.ReviewerViewModel>();
    var submission = ViewBag.Submission as SciSubmit.Models.Submission.Submission;
}

<div class="container-fluid my-4">
    <!-- TempData Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>@TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-user-tie me-2"></i>Phân công phản biện
                </h2>
                @if (submission != null)
                {
                    <p class="text-muted mb-0">Chọn Reviewer cho bài báo: <strong>@submission.Title</strong></p>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Không tìm thấy thông tin bài báo. Vui lòng chọn bài báo từ danh sách.
                    </div>
                }
            </div>
            <div>
                <a href="@Url.Action("SubmissionDetails", new { id = Model })" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Submission Selection (if needed) -->
            @if (submission == null)
            {
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Chọn bài báo</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Vui lòng quay lại trang <a href="@Url.Action("Submissions")">Quản lý bài nộp</a> và chọn một bài báo để phân công phản biện.
                        </div>
                    </div>
                </div>
            }
            
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Danh sách Reviewer gợi ý</h5>
                </div>
                <div class="card-body">
                    @if (submission == null)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Không tìm thấy bài báo. Vui lòng quay lại và chọn bài báo trước.
                        </div>
                    }
                    else if (availableReviewers.Any())
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-robot me-2"></i>
                            <strong>Gợi ý dựa trên từ khóa:</strong> Các Reviewer được sắp xếp theo độ phù hợp với bài báo.
                        </div>

                        <form method="post" action="@Url.Action("AssignReviewer")" id="assignReviewerForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="submissionId" id="submissionId" value="@Model" />
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Chọn Reviewer <span class="text-danger">*</span></label>
                                <select name="reviewerId" id="reviewerSelect" class="form-select" required>
                                    <option value="">-- Chọn Reviewer --</option>
                                    @foreach (var reviewer in availableReviewers)
                                    {
                                        <option value="@reviewer.Id" 
                                                data-email="@reviewer.Email"
                                                data-affiliation="@reviewer.Affiliation"
                                                data-matchscore="@reviewer.MatchScore"
                                                data-keywords="@string.Join(",", reviewer.Keywords)"
                                                data-activeassignments="@reviewer.ActiveAssignments">
                                            @reviewer.FullName (@reviewer.MatchScore% phù hợp) - @reviewer.Email
                                        </option>
                                    }
                                </select>
                                <div class="invalid-feedback" id="reviewerError" style="display: none;">
                                    Vui lòng chọn một Reviewer.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Deadline phản biện <span class="text-danger">*</span></label>
                                <input type="datetime-local" name="deadline" id="deadlineInput" class="form-control" required min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                                <small class="text-muted">Chọn thời hạn để Reviewer hoàn thành phản biện (phải trong tương lai)</small>
                                <div class="invalid-feedback" id="deadlineError" style="display: none;">
                                    Vui lòng chọn deadline trong tương lai.
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <a href="@Url.Action("SubmissionDetails", new { id = Model })" class="btn btn-secondary">Hủy</a>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="fas fa-paper-plane me-2"></i>Phân công
                                </button>
                            </div>
                        </form>

                        <hr class="my-4">

                        <h6 class="mb-3">Chi tiết Reviewer:</h6>
                        <div id="reviewerDetails">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Vui lòng chọn một Reviewer từ dropdown ở trên để xem chi tiết.
                            </div>
                        </div>
                        
                        <div id="allReviewersList" style="display: none;">
                            @foreach (var reviewer in availableReviewers.Take(5))
                            {
                                <div class="card mb-2 reviewer-card @(reviewer.MatchScore >= 50 ? "border-primary" : "")" data-reviewer-id="@reviewer.Id">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">@reviewer.FullName</h6>
                                                <p class="text-muted mb-1 small">@reviewer.Email</p>
                                                @if (!string.IsNullOrEmpty(reviewer.Affiliation))
                                                {
                                                    <p class="text-muted mb-1 small">@reviewer.Affiliation</p>
                                                }
                                                @if (reviewer.Keywords.Any())
                                                {
                                                    <div class="mt-2">
                                                        @foreach (var keyword in reviewer.Keywords.Take(5))
                                                        {
                                                            <span class="badge bg-secondary me-1">@keyword</span>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            <div class="text-end">
                                                <span class="badge @(reviewer.MatchScore >= 50 ? "bg-success" : "bg-warning")">
                                                    @reviewer.MatchScore% phù hợp
                                                </span>
                                                <br>
                                                <small class="text-muted">@reviewer.ActiveAssignments assignments đang active</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (submission != null)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Không tìm thấy Reviewer nào trong hệ thống.</strong>
                            <br>
                            <small>Vui lòng:</small>
                            <ul class="mb-0 mt-2">
                                <li>Tạo Reviewer mới trong <a href="@Url.Action("Users")">Quản lý Người dùng</a> với role = Reviewer</li>
                                <li>Đảm bảo Reviewer có <code>IsActive = true</code></li>
                                <li>Thêm keywords cho Reviewer để được gợi ý tốt hơn</li>
                            </ul>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-hide alerts after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);

        // Handle reviewer selection
        $(document).ready(function() {
            const reviewerSelect = $('#reviewerSelect');
            const reviewerDetails = $('#reviewerDetails');
            const allReviewersList = $('#allReviewersList');
            const assignForm = $('#assignReviewerForm');
            
            // Auto-select first reviewer if only one option
            if (reviewerSelect.find('option').length === 2) {
                reviewerSelect.val(reviewerSelect.find('option:not(:first)').val());
                reviewerSelect.trigger('change');
            }
            
            // Form validation before submit
            assignForm.on('submit', function(e) {
                const reviewerId = reviewerSelect.val();
                const deadline = $('#deadlineInput').val();
                const submissionId = $('#submissionId').val();
                
                // Clear previous errors
                reviewerSelect.removeClass('is-invalid');
                $('#deadlineInput').removeClass('is-invalid');
                $('#reviewerError').hide();
                $('#deadlineError').hide();
                
                let hasError = false;
                
                // Validate reviewer
                if (!reviewerId || reviewerId === '') {
                    reviewerSelect.addClass('is-invalid');
                    $('#reviewerError').show();
                    hasError = true;
                }
                
                // Validate deadline
                if (!deadline) {
                    $('#deadlineInput').addClass('is-invalid');
                    $('#deadlineError').text('Vui lòng chọn deadline.');
                    $('#deadlineError').show();
                    hasError = true;
                } else {
                    const deadlineDate = new Date(deadline);
                    const now = new Date();
                    if (deadlineDate <= now) {
                        $('#deadlineInput').addClass('is-invalid');
                        $('#deadlineError').text('Deadline phải trong tương lai.');
                        $('#deadlineError').show();
                        hasError = true;
                    }
                }
                
                // Validate submissionId
                if (!submissionId || submissionId <= 0) {
                    alert('Lỗi: Không tìm thấy bài báo. Vui lòng quay lại và thử lại.');
                    hasError = true;
                }
                
                if (hasError) {
                    e.preventDefault();
                    return false;
                }
                
                // Log values for debugging
                console.log('Submitting form with:');
                console.log('  submissionId:', submissionId);
                console.log('  reviewerId:', reviewerId);
                console.log('  deadline:', deadline);
                
                // Show loading state
                $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...');
            });
            
            // Show reviewer details when selected
            reviewerSelect.on('change', function() {
                const selectedOption = $(this).find('option:selected');
                const reviewerId = selectedOption.val();
                
                if (!reviewerId) {
                    reviewerDetails.html('<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Vui lòng chọn một Reviewer từ dropdown ở trên để xem chi tiết.</div>');
                    allReviewersList.hide();
                    return;
                }
                
                // Get reviewer data from option attributes
                const email = selectedOption.data('email');
                const affiliation = selectedOption.data('affiliation') || '';
                const matchScore = selectedOption.data('matchscore');
                const keywords = selectedOption.data('keywords') || '';
                const activeAssignments = selectedOption.data('activeassignments');
                
                // Build keywords HTML
                let keywordsHtml = '';
                if (keywords) {
                    const keywordArray = keywords.split(',').filter(k => k.trim());
                    keywordsHtml = '<div class="mt-2">';
                    keywordArray.forEach(function(keyword) {
                        keywordsHtml += '<span class="badge bg-secondary me-1">' + keyword.trim() + '</span>';
                    });
                    keywordsHtml += '</div>';
                }
                
                // Build reviewer details HTML
                const detailsHtml = `
                    <div class="card mb-2 border-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${selectedOption.text().split('(')[0].trim()}</h6>
                                    <p class="text-muted mb-1 small">${email}</p>
                                    ${affiliation ? '<p class="text-muted mb-1 small">' + affiliation + '</p>' : ''}
                                    ${keywordsHtml}
                                </div>
                                <div class="text-end">
                                    <span class="badge ${matchScore >= 50 ? 'bg-success' : 'bg-warning'}">
                                        ${matchScore}% phù hợp
                                    </span>
                                    <br>
                                    <small class="text-muted">${activeAssignments} assignments đang active</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                reviewerDetails.html(detailsHtml);
                
                // Highlight selected reviewer in list
                $('.reviewer-card').removeClass('border-primary border-warning');
                $('.reviewer-card[data-reviewer-id="' + reviewerId + '"]').addClass('border-primary');
                allReviewersList.show();
            });
            
            // Trigger change on page load if reviewer is already selected
            if (reviewerSelect.val()) {
                reviewerSelect.trigger('change');
            }
        });
    </script>
}

