@model SciSubmit.Models.Admin.CommitteeViewModel
@{
    ViewData["Title"] = "Committee Management";
}

@section Styles {
    <link rel="stylesheet" href="~/css/committee-admin.css" asp-append-version="true" />
}

<div class="container-fluid my-4">
    <!-- TempData Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-users-cog me-2"></i>Committee Management
                </h2>
                <p class="text-muted mb-0">Manage committee sections and members</p>
            </div>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSectionModal">
                    <i class="fas fa-plus me-2"></i>Add Section
                </button>
            </div>
        </div>
    </div>

    <!-- Committee Sections -->
    <div id="committeeSections">
        @if (Model.Sections == null || !Model.Sections.Any())
        {
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No committee sections found. Click "Add Section" to get started.
            </div>
        }
        else
        {
            @foreach (var sec in Model.Sections.OrderBy(s => s.OrderIndex))
            {
                <div class="card shadow-sm border-0 mb-4 committee-section-card" data-section-id="@sec.Id">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-layer-group me-2"></i>@sec.Title
                            @if (!sec.IsActive)
                            {
                                <span class="badge bg-secondary ms-2">Inactive</span>
                            }
                        </h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-light me-2" onclick="editSection(@sec.Id)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-light me-2" onclick="addMember(@sec.Id)">
                                <i class="fas fa-user-plus"></i> Add Member
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteSection(@sec.Id)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <strong>Type:</strong> @(sec.SectionType) | 
                                    <strong>Order:</strong> @sec.OrderIndex
                                </small>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(sec.Description))
                        {
                            <p class="text-muted mb-3">@sec.Description</p>
                        }
                        <div class="committee-members-list">
                            @if (sec.Members == null || !sec.Members.Any())
                            {
                                <p class="text-muted">No members in this section.</p>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Title</th>
                                                <th>Affiliation</th>
                                                <th>Order</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var member in sec.Members.OrderBy(m => m.OrderIndex))
                                            {
                                                <tr>
                                                    <td>@member.Name</td>
                                                    <td>@(member.Title ?? "-")</td>
                                                    <td>@(member.Affiliation ?? "-")</td>
                                                    <td>@member.OrderIndex</td>
                                                    <td>
                                                        @if (member.IsActive)
                                                        {
                                                            <span class="badge bg-success">Active</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">Inactive</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editMember(@member.Id, @sec.Id)">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteMember(@member.Id)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- Add/Edit Section Modal -->
<div class="modal fade" id="addSectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sectionModalTitle">Add Section</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sectionForm">
                    <input type="hidden" id="sectionId" name="Id" value="0" />
                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="sectionTitle" name="Title" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="sectionDescription" name="Description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Section Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="sectionType" name="SectionType" required>
                            <option value="Standard">Standard</option>
                            <option value="GeneralChair">General Chair</option>
                            <option value="ProgramCommittee">Program Committee</option>
                            <option value="TrackChairs">Track Chairs</option>
                            <option value="KeynoteSpeakers">Keynote Speakers</option>
                            <option value="PublicationChairs">Publication Chairs</option>
                            <option value="LocalOrganizing">Local Organizing Committee</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Order Index</label>
                            <input type="number" class="form-control" id="sectionOrderIndex" name="OrderIndex" value="0" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="sectionIsActive" name="IsActive" checked />
                                <label class="form-check-label" for="sectionIsActive">Active</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSection()">Save Section</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Member Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberModalTitle">Add Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="memberForm">
                    <input type="hidden" id="memberId" name="Id" value="0" />
                    <input type="hidden" id="memberSectionId" name="CommitteeSectionId" />
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="memberName" name="Name" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="memberTitle" name="Title" placeholder="Prof., Assoc. Prof. Dr., etc." />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Affiliation</label>
                            <input type="text" class="form-control" id="memberAffiliation" name="Affiliation" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Country</label>
                            <input type="text" class="form-control" id="memberCountry" name="Country" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="memberDescription" name="Description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Photo URL</label>
                        <input type="url" class="form-control" id="memberPhotoUrl" name="PhotoUrl" />
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Topic</label>
                            <input type="text" class="form-control" id="memberTopic" name="Topic" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Order Index</label>
                            <input type="number" class="form-control" id="memberOrderIndex" name="OrderIndex" value="0" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Track Name</label>
                            <input type="text" class="form-control" id="memberTrackName" name="TrackName" placeholder="Track 1, Track 2, etc." />
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="memberIsActive" name="IsActive" checked />
                                <label class="form-check-label" for="memberIsActive">Active</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Track Description</label>
                        <textarea class="form-control" id="memberTrackDescription" name="TrackDescription" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMember()">Save Member</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken()
    <script>

        function editSection(id) {
            // Load section data from server
            $.ajax({
                url: '@Url.Action("GetCommitteeSection", "Admin")',
                type: 'GET',
                data: { id: id },
                success: function(data) {
                    $('#sectionId').val(data.id);
                    $('#sectionTitle').val(data.title);
                    $('#sectionDescription').val(data.description || '');
                    $('#sectionType').val(data.sectionType);
                    $('#sectionOrderIndex').val(data.orderIndex);
                    $('#sectionIsActive').prop('checked', data.isActive);
            $('#sectionModalTitle').text('Edit Section');
            $('#addSectionModal').modal('show');
                },
                error: function() {
                    alert('Error loading section data');
                }
            });
        }

        function addMember(sectionId) {
            $('#memberId').val(0);
            $('#memberSectionId').val(sectionId);
            $('#memberModalTitle').text('Add Member');
            $('#memberForm')[0].reset();
            $('#addMemberModal').modal('show');
        }

        function editMember(memberId, sectionId) {
            // Load member data from server
            $.ajax({
                url: '@Url.Action("GetCommitteeMember", "Admin")',
                type: 'GET',
                data: { id: memberId },
                success: function(data) {
                    $('#memberId').val(data.id);
                    $('#memberSectionId').val(data.committeeSectionId);
                    $('#memberName').val(data.name);
                    $('#memberTitle').val(data.title || '');
                    $('#memberAffiliation').val(data.affiliation || '');
                    $('#memberCountry').val(data.country || '');
                    $('#memberDescription').val(data.description || '');
                    $('#memberPhotoUrl').val(data.photoUrl || '');
                    $('#memberTopic').val(data.topic || '');
                    $('#memberTrackName').val(data.trackName || '');
                    $('#memberTrackDescription').val(data.trackDescription || '');
                    $('#memberOrderIndex').val(data.orderIndex);
                    $('#memberIsActive').prop('checked', data.isActive);
            $('#memberModalTitle').text('Edit Member');
            $('#addMemberModal').modal('show');
                },
                error: function() {
                    alert('Error loading member data');
                }
            });
        }

        function saveSection() {
            const formData = {
                Id: parseInt($('#sectionId').val()),
                Title: $('#sectionTitle').val(),
                Description: $('#sectionDescription').val(),
                SectionType: $('#sectionType').val(),
                OrderIndex: parseInt($('#sectionOrderIndex').val()),
                IsActive: $('#sectionIsActive').is(':checked')
            };

            $.ajax({
                url: '@Url.Action("SaveCommitteeSection", "Admin")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error saving section');
                    }
                },
                error: function() {
                    alert('Error saving section');
                }
            });
        }

        function saveMember() {
            const formData = {
                Id: parseInt($('#memberId').val()),
                CommitteeSectionId: parseInt($('#memberSectionId').val()),
                Name: $('#memberName').val(),
                Title: $('#memberTitle').val(),
                Affiliation: $('#memberAffiliation').val(),
                Country: $('#memberCountry').val(),
                Description: $('#memberDescription').val(),
                PhotoUrl: $('#memberPhotoUrl').val(),
                Topic: $('#memberTopic').val(),
                TrackName: $('#memberTrackName').val(),
                TrackDescription: $('#memberTrackDescription').val(),
                OrderIndex: parseInt($('#memberOrderIndex').val()),
                IsActive: $('#memberIsActive').is(':checked')
            };

            $.ajax({
                url: '@Url.Action("SaveCommitteeMember", "Admin")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error saving member');
                    }
                },
                error: function() {
                    alert('Error saving member');
                }
            });
        }

        function deleteSection(id) {
            if (!confirm('Are you sure you want to delete this section? All members will also be deleted.')) {
                return;
            }

            $.ajax({
                url: '@Url.Action("DeleteCommitteeSection", "Admin")',
                type: 'POST',
                data: { id: id },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error deleting section');
                    }
                },
                error: function() {
                    alert('Error deleting section');
                }
            });
        }

        function deleteMember(id) {
            if (!confirm('Are you sure you want to delete this member?')) {
                return;
            }

            $.ajax({
                url: '@Url.Action("DeleteCommitteeMember", "Admin")',
                type: 'POST',
                data: { id: id },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error deleting member');
                    }
                },
                error: function() {
                    alert('Error deleting member');
                }
            });
        }

        // Reset modal when closed
        $('#addSectionModal').on('hidden.bs.modal', function() {
            $('#sectionForm')[0].reset();
            $('#sectionId').val(0);
            $('#sectionModalTitle').text('Add Section');
        });

        $('#addMemberModal').on('hidden.bs.modal', function() {
            $('#memberForm')[0].reset();
            $('#memberId').val(0);
            $('#memberModalTitle').text('Add Member');
        });

        // Auto-hide alerts
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
    </script>
}

