@model SciSubmit.Models.Admin.FinalDecisionViewModel
@{
    ViewData["Title"] = "Ra quyết định cuối cùng";
}

<div class="container-fluid my-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="mb-4">
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-gavel me-2"></i>Ra quyết định cuối cùng
                </h2>
                <p class="text-muted">Xem tất cả phản biện và ra quyết định cuối cùng</p>
            </div>

            <!-- Submission Info -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Thông tin bài báo</h5>
                </div>
                <div class="card-body">
                    <h5 class="mb-3">@Model.SubmissionTitle</h5>
                    <div class="row">
                        <div class="col-md-6">
                            @foreach (var topic in Model.Topics)
                            {
                                <span class="badge bg-info me-1">@topic</span>
                            }
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">Mã bài: #@Model.SubmissionId</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Summary -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Tổng hợp phản biện</h5>
                </div>
                <div class="card-body">
                    <!-- Average Score -->
                    <div class="text-center mb-4 p-4 bg-light rounded">
                        <h6 class="text-muted mb-2">Điểm trung bình</h6>
                        <h2 class="text-primary mb-0">@Model.AverageScore.ToString("F1") / 5.0</h2>
                        <small class="text-muted">Từ @Model.CompletedReviews / @Model.TotalReviews phản biện</small>
                    </div>

                    @if (Model.Reviews.Any())
                    {
                        @foreach (var review in Model.Reviews)
                        {
                            <div class="mb-4 @(review != Model.Reviews.Last() ? "pb-4 border-bottom" : "")">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="mb-1">Phản biện @(Model.Reviews.IndexOf(review) + 1)</h6>
                                        <small class="text-muted">@review.ReviewerName</small>
                                    </div>
                                    <span class="badge @(review.Recommendation?.ToLower() == "accept" ? "bg-success" : review.Recommendation?.ToLower().Contains("minor") == true ? "bg-warning" : review.Recommendation?.ToLower().Contains("major") == true ? "bg-warning" : "bg-danger")">
                                        @review.Recommendation
                                    </span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Điểm: </small>
                                    <span class="badge bg-primary">@review.Score.ToString("F1")/5</span>
                                    <small class="text-muted ms-2">Ngày nộp: @review.SubmittedAt.ToString("dd/MM/yyyy")</small>
                                </div>
                                @if (!string.IsNullOrEmpty(review.CommentsForAuthor))
                                {
                                    <div class="bg-light p-3 rounded">
                                        <p class="mb-0 small">@review.CommentsForAuthor</p>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Chưa có phản biện nào hoàn thành.
                        </div>
                    }
                </div>
            </div>

            <!-- System Recommendation -->
            <div class="card shadow-sm border-0 mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Gợi ý từ hệ thống</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        @{
                            var recClass = Model.SystemRecommendation switch
                            {
                                "Accept" => "text-success",
                                "MinorRevision" => "text-warning",
                                "MajorRevision" => "text-warning",
                                "Reject" => "text-danger",
                                _ => "text-info"
                            };
                            var recIcon = Model.SystemRecommendation switch
                            {
                                "Accept" => "fa-check-circle",
                                "MinorRevision" => "fa-edit",
                                "MajorRevision" => "fa-edit",
                                "Reject" => "fa-times-circle",
                                _ => "fa-info-circle"
                            };
                            var recText = Model.SystemRecommendation switch
                            {
                                "Accept" => "Chấp nhận",
                                "MinorRevision" => "Chỉnh sửa nhỏ",
                                "MajorRevision" => "Chỉnh sửa lớn",
                                "Reject" => "Từ chối",
                                _ => "Chưa có"
                            };
                        }
                        <i class="fas @recIcon fa-2x @recClass me-3"></i>
                        <div>
                            <h5 class="@recClass mb-1">Khuyến nghị: @recText</h5>
                            <p class="text-muted mb-0">
                                Dựa trên điểm trung bình @Model.AverageScore.ToString("F1")/5 và @Model.CompletedReviews phản biện đã hoàn thành
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Final Decision Form -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-gavel me-2"></i>Ra quyết định cuối cùng</h5>
                </div>
                <div class="card-body">
                    @if (!Model.CanMakeDecision)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Chưa thể ra quyết định. Cần ít nhất 1 phản biện hoàn thành.
                        </div>
                    }
                    
                    <form id="decisionForm" asp-action="MakeFinalDecision" method="post">
                        <input type="hidden" name="id" value="@Model.SubmissionId" />

                        <div class="mb-4">
                            <label class="form-label fw-semibold">Quyết định <span class="text-danger">*</span></label>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-success btn-lg w-100" onclick="setDecision('Accept')">
                                        <i class="fas fa-check me-2"></i>Chấp nhận
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-warning btn-lg w-100" onclick="setDecision('Minor')">
                                        <i class="fas fa-edit me-2"></i>Chỉnh sửa nhỏ
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-warning btn-lg w-100" onclick="setDecision('Major')">
                                        <i class="fas fa-edit me-2"></i>Chỉnh sửa lớn
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-danger btn-lg w-100" onclick="setDecision('Reject')">
                                        <i class="fas fa-times me-2"></i>Từ chối
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" name="decision" id="decisionInput" required />
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold">Ghi chú (tùy chọn)</label>
                            <textarea name="comments" class="form-control" rows="4" 
                                      placeholder="Nhập ghi chú bổ sung (nếu có)"></textarea>
                        </div>

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Sau khi ra quyết định, hệ thống sẽ tự động gửi email thông báo kết quả và các bình luận (ẩn danh) cho tác giả.
                        </div>

                        <div class="d-flex justify-content-end">
                            <a href="/Admin/Submissions" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-times me-2"></i>Hủy
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit" disabled="@(!Model.CanMakeDecision)">
                                <i class="fas fa-paper-plane me-2"></i>Xác nhận quyết định
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function setDecision(decision) {
            document.getElementById('decisionInput').value = decision;
            document.getElementById('btnSubmit').disabled = false;
            
            // Update button styles
            document.querySelectorAll('.btn-lg').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
    </script>

    <style>
        .btn-lg.active {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
}
