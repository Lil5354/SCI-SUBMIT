@model SciSubmit.Models.Admin.PagedList<SciSubmit.Models.Admin.KeywordViewModel>
@using SciSubmit.Models.Enums
@{
    ViewData["Title"] = "Manage Keywords";
    var filter = ViewBag.Filter as SciSubmit.Models.Admin.KeywordFilterViewModel ?? new SciSubmit.Models.Admin.KeywordFilterViewModel();
    var approvedKeywords = Model.Items.Where(k => k.Status == KeywordStatus.Approved).ToList();
    var pendingKeywords = Model.Items.Where(k => k.Status == KeywordStatus.Pending).ToList();
}

@Html.AntiForgeryToken()

<div class="container-fluid my-4">
    <!-- TempData Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-tags me-2"></i>Manage Keywords
                </h2>
                <p class="text-muted mb-0">Approve and manage professional keywords in the system</p>
            </div>
            <div>
                <button class="btn btn-primary" onclick="showAddKeywordModal()">
                    <i class="fas fa-plus me-2"></i>Add Keyword
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button">
                <i class="fas fa-check-circle me-2"></i>Approved (<span id="approvedCount">@approvedKeywords.Count</span>)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                <i class="fas fa-clock me-2"></i>Pending (<span id="pendingCount">@pendingKeywords.Count</span>)
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Approved Keywords -->
        <div class="tab-pane fade show active" id="approved" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    @if (approvedKeywords.Any())
                    {
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            @foreach (var keyword in approvedKeywords)
                            {
                                <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    @keyword.Name
                                    <button type="button" class="btn-close btn-close-white ms-2" onclick="deleteKeyword(@keyword.Id, '@keyword.Name')" title="Delete"></button>
                                </span>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No approved keywords found.
                        </div>
                    }
                        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                            Tài chính
                            <button type="button" class="btn-close btn-close-white ms-2" onclick="deleteKeyword('Tài chính', 'approved')"></button>
                        </span>
                        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                            Quản lý
                            <button type="button" class="btn-close btn-close-white ms-2" onclick="deleteKeyword('Quản lý', 'approved')"></button>
                        </span>
                        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                            Kinh tế
                            <button type="button" class="btn-close btn-close-white ms-2" onclick="deleteKeyword('Kinh tế', 'approved')"></button>
                        </span>
                        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                            Marketing
                            <button type="button" class="btn-close btn-close-white ms-2" onclick="deleteKeyword('Marketing', 'approved')"></button>
                        </span>
                        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                            Thương mại điện tử
                            <button type="button" class="btn-close btn-close-white ms-2" onclick="deleteKeyword('Thương mại điện tử', 'approved')"></button>
                        </span>
                        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                            Blockchain
                            <button type="button" class="btn-close btn-close-white ms-2" onclick="deleteKeyword('Blockchain', 'approved')"></button>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Keywords -->
        <div class="tab-pane fade" id="pending" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" style="table-layout: fixed; width: 100%;">
                            <colgroup>
                                <col style="width: 30%;">
                                <col style="width: 25%;">
                                <col style="width: 20%;">
                                <col style="width: 25%;">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th style="width: 30%; min-width: 150px; padding: 12px; vertical-align: middle; box-sizing: border-box;">Keyword</th>
                                    <th style="width: 25%; min-width: 150px; padding: 12px; vertical-align: middle; box-sizing: border-box;">Proposed By</th>
                                    <th style="width: 20%; min-width: 120px; padding: 12px; text-align: center; vertical-align: middle; box-sizing: border-box;">Date Proposed</th>
                                    <th style="width: 25%; min-width: 150px; padding: 12px; text-align: center; vertical-align: middle; box-sizing: border-box;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (pendingKeywords.Any())
                                {
                                    @foreach (var keyword in pendingKeywords)
                                    {
                                        <tr>
                                            <td style="width: 30%; min-width: 150px; padding: 12px; vertical-align: middle; box-sizing: border-box; overflow: hidden; word-wrap: break-word;">
                                                <strong style="word-wrap: break-word; overflow-wrap: break-word;">@keyword.Name</strong>
                                            </td>
                                            <td style="width: 25%; min-width: 150px; padding: 12px; vertical-align: middle; box-sizing: border-box; overflow: hidden; word-wrap: break-word;">
                                                @(keyword.CreatedByName ?? "N/A")
                                            </td>
                                            <td style="width: 20%; min-width: 120px; padding: 12px; text-align: center; vertical-align: middle; box-sizing: border-box; overflow: hidden; white-space: nowrap;">
                                                @keyword.CreatedAt.ToString("dd/MM/yyyy")
                                            </td>
                                            <td style="width: 25%; min-width: 150px; padding: 12px; text-align: center; vertical-align: middle; box-sizing: border-box; overflow: hidden;">
                                                <div class="d-flex justify-content-center gap-1">
                                                    <button class="btn btn-sm btn-success" onclick="approveKeyword(@keyword.Id, '@keyword.Name')" title="Approve">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="rejectKeyword(@keyword.Id, '@keyword.Name')" title="Reject">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-4">
                                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">No pending keywords</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Keyword Modal -->
<div class="modal fade" id="keywordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add New Keyword</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="keywordForm">
                    <div class="mb-3">
                        <label class="form-label">Keyword <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="Keyword" required />
                        <small class="form-text text-muted">Keyword will be added to the approved list immediately</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveKeyword()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showAddKeywordModal() {
            document.getElementById('keywordForm').reset();
            new bootstrap.Modal(document.getElementById('keywordModal')).show();
        }

        function getToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
        }

        function approveKeyword(id, name) {
            if (confirm(`Approve keyword "${name}"?`)) {
                fetch('@Url.Action("ApproveKeyword", "Admin")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getToken()
                    },
                    body: JSON.stringify({ KeywordId: id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error approving keyword.');
                });
            }
        }

        function rejectKeyword(id, name) {
            if (confirm(`Reject keyword "${name}"?`)) {
                fetch('@Url.Action("RejectKeyword", "Admin")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getToken()
                    },
                    body: JSON.stringify({ KeywordId: id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error rejecting keyword.');
                });
            }
        }

        function deleteKeyword(id, name) {
            if (confirm(`Delete keyword "${name}"?`)) {
                fetch('@Url.Action("DeleteKeyword", "Admin")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getToken()
                    },
                    body: JSON.stringify({ KeywordId: id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting keyword.');
                });
            }
        }

        function saveKeyword() {
            const keywordName = document.querySelector('#keywordForm input[name="Keyword"]').value;
            if (!keywordName) {
                alert('Please enter keyword name.');
                return;
            }

            fetch('@Url.Action("CreateKeyword", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getToken()
                },
                body: JSON.stringify({ name: keywordName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('keywordModal')).hide();
                    location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding keyword.');
            });
        }
    </script>
}
