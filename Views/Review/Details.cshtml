@model SciSubmit.Models.Review.ReviewDetailsViewModel
@{
    ViewData["Title"] = "Review Paper";
    ViewData["HideMainHeader"] = true;
}

@await Html.PartialAsync("_ReviewerNavHeader")

<div class="container my-5">
    <!-- Header -->
    <div class="mb-4">
        <h2 class="text-gradient mb-2">
            <i class="fas fa-clipboard-check me-2"></i>Review Paper
        </h2>
        <p class="text-muted">Perform anonymous review (Blind Review)</p>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Paper Information Card (Blind Review - No Author Name) -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Paper Information</h5>
        </div>
        <div class="card-body p-4">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <h4 class="fw-bold">@Model.Title</h4>
                </div>
                <div class="col-md-12 mb-3">
                    <h6 class="text-muted mb-2">Abstract:</h6>
                    <p class="text-justify">@Model.Abstract</p>
                </div>
                <div class="col-md-12 mb-3">
                    <h6 class="text-muted mb-2">Topic:</h6>
                    <div>
                        @foreach (var topic in Model.Topics)
                        {
                            <span class="badge bg-info me-1 mb-1">@topic</span>
                        }
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2">Review Deadline:</h6>
                    <p class="@(Model.IsUrgent ? "text-danger fw-bold" : "")">
                        <i class="fas fa-calendar-alt me-2"></i>@Model.Deadline.ToString("dd/MM/yyyy HH:mm")
                        @if (Model.DaysRemaining > 0)
                        {
                            <span class="badge @(Model.IsUrgent ? "bg-danger" : "bg-warning") ms-2">
                                Còn @Model.DaysRemaining ngày
                            </span>
                        }
                        else if (Model.DaysRemaining == 0)
                        {
                            <span class="badge bg-danger ms-2">Hết hạn hôm nay!</span>
                        }
                        else
                        {
                            <span class="badge bg-danger ms-2">Đã quá hạn @Math.Abs(Model.DaysRemaining) ngày</span>
                        }
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted mb-2">Documents:</h6>
                    <div class="d-flex gap-2 flex-wrap">
                        @if (!string.IsNullOrEmpty(Model.AbstractFileUrl))
                        {
                            <a href="@Model.AbstractFileUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file-pdf me-1"></i>View Abstract
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(Model.FullPaperFileUrl))
                        {
                            <a href="@Model.FullPaperFileUrl" target="_blank" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-file-alt me-1"></i>View Full Paper
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Form -->
    <form id="reviewForm" asp-action="SubmitReview" asp-route-id="@Model.AssignmentId" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="AssignmentId" value="@Model.AssignmentId" />
        
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-star me-2"></i>Evaluation by Criteria (1-@Model.Criteria.FirstOrDefault()?.MaxScore ?? 5)</h5>
            </div>
            <div class="card-body p-4">
                @if (Model.Criteria.Any())
                {
                    @foreach (var criterion in Model.Criteria.OrderBy(c => c.OrderIndex))
                    {
                        <div class="mb-4 p-3 border rounded">
                            <label class="form-label fw-semibold mb-2">
                                @criterion.Name
                                @if (!string.IsNullOrEmpty(criterion.Description))
                                {
                                    <small class="text-muted d-block">@criterion.Description</small>
                                }
                            </label>
                            <div class="d-flex gap-2 align-items-center flex-wrap">
                                @for (int i = 1; i <= criterion.MaxScore; i++)
                                {
                                    var scoreName = $"Scores[{criterion.Name}]";
                                    var isChecked = Model.HasExistingReview && Model.ExistingScores.ContainsKey(criterion.Name) && Model.ExistingScores[criterion.Name] == i;
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" 
                                               name="@scoreName" 
                                               id="score_@(criterion.Id)_@i" 
                                               value="@i" 
                                               @(isChecked ? "checked" : "") 
                                               required />
                                        <label class="form-check-label" for="score_@(criterion.Id)_@i">
                                            @i
                                        </label>
                                    </div>
                                }
                                <span class="text-danger small ms-2" id="error_@criterion.Id"></span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No evaluation criteria have been configured. Please contact Admin.
                    </div>
                }
            </div>
        </div>

        <!-- Comments for Author -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Comments for Author</h5>
            </div>
            <div class="card-body p-4">
                <p class="text-muted small mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Please provide detailed feedback so the author can revise and improve the paper.
                </p>
                <textarea name="CommentsForAuthor" 
                          class="form-control" 
                          rows="8" 
                          placeholder="Enter detailed comments for the author..." 
                          required 
                          minlength="10">@(Model.HasExistingReview ? Model.ExistingCommentsForAuthor : "")</textarea>
                <small class="form-text text-muted">Minimum 10 characters</small>
                <span class="text-danger small" id="commentsForAuthorError"></span>
            </div>
        </div>

        <!-- Private Comments for Admin -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-lock me-2"></i>Private Comments for Admin</h5>
            </div>
            <div class="card-body p-4">
                <p class="text-muted small mb-3">
                    <i class="fas fa-shield-alt me-1"></i>
                    These comments are only visible to Admin. Example: "This paper is suspected of plagiarism...", "Need to verify authenticity..."
                </p>
                <textarea name="CommentsForAdmin" 
                          class="form-control" 
                          rows="6" 
                          placeholder="Enter private comments for Admin (optional)...">@(Model.HasExistingReview ? Model.ExistingCommentsForAdmin : "")</textarea>
                <small class="form-text text-muted">Optional - Only Admin can view</small>
            </div>
        </div>

        <!-- Recommendation -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-gavel me-2"></i>Recommendation</h5>
            </div>
            <div class="card-body p-4">
                <select name="Recommendation" class="form-select form-select-lg" required>
                    <option value="">-- Select recommendation --</option>
                    @if (Model.HasExistingReview && Model.ExistingRecommendation == "Accept")
                    {
                        <option value="Accept" selected>Accept</option>
                    }
                    else
                    {
                        <option value="Accept">Accept</option>
                    }
                    @if (Model.HasExistingReview && Model.ExistingRecommendation == "MinorRevision")
                    {
                        <option value="MinorRevision" selected>Minor Revision</option>
                    }
                    else
                    {
                        <option value="MinorRevision">Minor Revision</option>
                    }
                    @if (Model.HasExistingReview && Model.ExistingRecommendation == "MajorRevision")
                    {
                        <option value="MajorRevision" selected>Major Revision</option>
                    }
                    else
                    {
                        <option value="MajorRevision">Major Revision</option>
                    }
                    @if (Model.HasExistingReview && Model.ExistingRecommendation == "Reject")
                    {
                        <option value="Reject" selected>Reject</option>
                    }
                    else
                    {
                        <option value="Reject">Reject</option>
                    }
                </select>
                <span class="text-danger small" id="recommendationError"></span>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                <i class="fas fa-paper-plane me-2"></i>Submit Review
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#reviewForm').on('submit', function(e) {
                e.preventDefault();
                
                var form = $(this);
                var submitBtn = $('#submitBtn');
                var originalText = submitBtn.html();
                
                // Validate all criteria are scored
                var criteriaNames = [];
                $('input[type="radio"][name^="Scores["]').each(function() {
                    var name = $(this).attr('name');
                    if (criteriaNames.indexOf(name) === -1) {
                        criteriaNames.push(name);
                    }
                });
                
                var allScored = true;
                var missingCriteria = [];
                criteriaNames.forEach(function(name) {
                    if ($('input[type="radio"][name="' + name + '"]:checked').length === 0) {
                        allScored = false;
                        var criterionName = name.match(/\[(.*?)\]/)[1];
                        missingCriteria.push(criterionName);
                    }
                });
                
                if (!allScored) {
                    alert('Please evaluate all criteria. Missing: ' + missingCriteria.join(', '));
                    return;
                }
                
                // Validate comments for author
                var commentsForAuthor = $('textarea[name="CommentsForAuthor"]').val().trim();
                if (commentsForAuthor.length < 10) {
                    alert('Comments for author must be at least 10 characters.');
                    $('#commentsForAuthorError').text('Comments must be at least 10 characters.');
                    return;
                }
                
                // Validate recommendation
                var recommendation = $('select[name="Recommendation"]').val();
                if (!recommendation) {
                    alert('Please select a recommendation.');
                    $('#recommendationError').text('Please select a recommendation.');
                    return;
                }
                
                // Disable submit button
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Processing...');
                
                // Submit via AJAX
                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    data: form.serialize(),
                    dataType: 'json',
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                    success: function(response) {
                        if (response && response.success) {
                            if (response.redirectUrl) {
                                window.location.href = response.redirectUrl;
                            } else {
                                window.location.href = '@Url.Action("Index", "Review")';
                            }
                        } else {
                            var errorMsg = (response && response.message) ? response.message : 'Unable to submit review. Please check your information.';
                            alert(errorMsg);
                            submitBtn.prop('disabled', false).html(originalText);
                        }
                    },
                    error: function(xhr, status, error) {
                        var errorMsg = 'Error submitting review.';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg = xhr.responseJSON.message;
                            } else if (xhr.responseText) {
                                var response = JSON.parse(xhr.responseText);
                                if (response.message) {
                                    errorMsg = response.message;
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing response:', e);
                        }
                        alert(errorMsg);
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });
        });
    </script>
}
