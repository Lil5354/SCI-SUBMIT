@{
    ViewData["Title"] = "Nộp tóm tắt bài báo";
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="mb-4">
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-file-alt me-2"></i>Nộp tóm tắt bài báo
                </h2>
                <p class="text-muted">Điền đầy đủ thông tin để nộp tóm tắt (Abstract) bài báo của bạn</p>
            </div>

            <!-- Auto-save Indicator -->
            <div id="autoSaveIndicator" class="alert alert-info alert-dismissible fade show" role="alert" style="display: none;">
                <i class="fas fa-save me-2"></i>
                <span id="autoSaveMessage">Đang lưu nháp tự động...</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Form -->
            <form id="submissionForm" asp-action="Create" method="post" enctype="multipart/form-data">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin bài báo</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Title -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-heading me-2 text-primary"></i>Tiêu đề <span class="text-danger">*</span>
                            </label>
                            <input type="text" id="titleInput" name="Title" class="form-control form-control-lg" 
                                   placeholder="Nhập tiêu đề bài báo" maxlength="200" required />
                            <div class="d-flex justify-content-between mt-1">
                                <small class="form-text text-muted">Tiêu đề phải ngắn gọn và mô tả đúng nội dung nghiên cứu</small>
                                <small class="text-muted">
                                    <span id="titleCharCount">0</span>/200 ký tự
                                </small>
                            </div>
                            <span class="text-danger small" id="titleError"></span>
                        </div>

                        <!-- Abstract -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-align-left me-2 text-primary"></i>Tóm tắt (Abstract) <span class="text-danger">*</span>
                            </label>
                            <textarea id="abstractInput" name="Abstract" class="form-control" rows="8" 
                                      placeholder="Nhập tóm tắt bài báo (150-300 từ)" required></textarea>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="form-text text-muted">Tóm tắt phải từ 150-300 từ</small>
                                <small class="text-muted">
                                    <span id="abstractWordCount">0</span> từ / 
                                    <span id="abstractCharCount">0</span> ký tự
                                </small>
                            </div>
                            <span class="text-danger small" id="abstractError"></span>
                        </div>

                        <!-- Keywords (Tag Input) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-tags me-2 text-primary"></i>Từ khóa (Keywords) <span class="text-danger">*</span>
                            </label>
                            <div id="keywordsContainer" class="mb-2 p-3 border rounded" style="min-height: 60px; background: var(--color-gray-50);">
                                <!-- Tags will be added here -->
                            </div>
                            <div class="input-group">
                                <input type="text" id="keywordInput" class="form-control" 
                                       placeholder="Nhập từ khóa và nhấn Enter (tối đa 5-6 từ)" 
                                       autocomplete="off" />
                                <button type="button" class="btn btn-outline-primary" onclick="addKeyword()">
                                    <i class="fas fa-plus"></i> Thêm
                                </button>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="form-text text-muted">Gõ từ khóa và nhấn Enter để thêm. Tối đa 5-6 từ khóa.</small>
                                <small class="text-muted">
                                    <span id="keywordCount">0</span>/6 từ khóa
                                </small>
                            </div>
                            <div id="keywordSuggestions" class="mt-2" style="display: none;">
                                <small class="text-muted">Gợi ý:</small>
                                <div id="suggestionsList" class="d-flex flex-wrap gap-2 mt-1"></div>
                            </div>
                            <input type="hidden" id="keywordsInput" name="Keywords" value="" />
                            <span class="text-danger small" id="keywordsError"></span>
                        </div>

                        <!-- Topic (Dropdown) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-list me-2 text-primary"></i>Chủ đề (Topic) <span class="text-danger">*</span>
                            </label>
                            <select id="topicSelect" name="Topic" class="form-select form-select-lg" required>
                                <option value="">-- Chọn chủ đề --</option>
                                <option value="Kinh tế">Kinh tế</option>
                                <option value="Tài chính & Kế toán">Tài chính & Kế toán</option>
                                <option value="Thương mại">Thương mại</option>
                                <option value="Quản trị kinh doanh">Quản trị kinh doanh</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Du lịch & Môi trường">Du lịch & Môi trường</option>
                                <option value="Tích hợp quốc tế">Tích hợp quốc tế</option>
                            </select>
                            <small class="form-text text-muted mt-1">Chủ đề do Admin quy định</small>
                            <span class="text-danger small" id="topicError"></span>
                        </div>

                        <!-- Authors (Dynamic) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-users me-2 text-primary"></i>Thông tin Tác giả <span class="text-danger">*</span>
                            </label>
                            <div id="authorsContainer">
                                <!-- Authors will be added here -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addAuthor()">
                                <i class="fas fa-plus me-1"></i>Thêm tác giả
                            </button>
                            <small class="form-text text-muted d-block mt-2">Phải có ít nhất một tác giả chính (corresponding author)</small>
                            <span class="text-danger small" id="authorsError"></span>
                        </div>

                        <!-- Optional File Upload -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-file-upload me-2 text-primary"></i>File hỗ trợ (Tùy chọn)
                            </label>
                            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                                <div class="text-center py-4">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <h6>Kéo thả file vào đây hoặc click để chọn</h6>
                                    <p class="text-muted mb-0">PDF, DOCX (Tối đa 10MB)</p>
                                </div>
                            </div>
                            <input type="file" id="fileInput" name="SupportFile" class="d-none" 
                                   accept=".pdf,.doc,.docx" />
                            <div id="fileList" class="mt-3"></div>
                            <small class="form-text text-muted">File hỗ trợ là tùy chọn, không bắt buộc</small>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow-sm border-0 mt-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-primary" id="btnSaveDraft" onclick="saveDraft()">
                                <i class="fas fa-save me-2"></i>Lưu nháp
                            </button>
                            <div class="ms-auto">
                                <a href="/Submission/Index" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-times me-2"></i>Hủy
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">
                                    <i class="fas fa-paper-plane me-2"></i>Nộp bài
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Global variables
        let keywords = [];
        let authors = [];
        let autoSaveInterval;
        let lastSaveTime = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add first author by default
            addAuthor();
            setFirstAuthorAsCorresponding();

            // Character counters
            document.getElementById('titleInput')?.addEventListener('input', updateTitleCounter);
            document.getElementById('abstractInput')?.addEventListener('input', updateAbstractCounter);

            // Keyword input handlers
            document.getElementById('keywordInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addKeyword();
                }
            });

            document.getElementById('keywordInput')?.addEventListener('input', function() {
                // TODO: Show keyword suggestions from database
                // For now, just hide suggestions
                document.getElementById('keywordSuggestions').style.display = 'none';
            });

            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(autoSave, 30000);

            // Manual save draft button
            document.getElementById('btnSaveDraft')?.addEventListener('click', saveDraft);

            // Form submission
            document.getElementById('submissionForm')?.addEventListener('submit', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    return false;
                }
            });
        });

        // Title character counter
        function updateTitleCounter() {
            const input = document.getElementById('titleInput');
            const count = input.value.length;
            document.getElementById('titleCharCount').textContent = count;
            
            if (count > 200) {
                document.getElementById('titleError').textContent = 'Tiêu đề không được vượt quá 200 ký tự';
                input.classList.add('is-invalid');
            } else {
                document.getElementById('titleError').textContent = '';
                input.classList.remove('is-invalid');
            }
        }

        // Abstract word/character counter
        function updateAbstractCounter() {
            const textarea = document.getElementById('abstractInput');
            const text = textarea.value.trim();
            const words = text ? text.split(/\s+/).filter(w => w.length > 0) : [];
            const wordCount = words.length;
            const charCount = text.length;

            document.getElementById('abstractWordCount').textContent = wordCount;
            document.getElementById('abstractCharCount').textContent = charCount;

            if (wordCount < 150) {
                document.getElementById('abstractError').textContent = 'Tóm tắt phải có ít nhất 150 từ';
                textarea.classList.add('is-invalid');
            } else if (wordCount > 300) {
                document.getElementById('abstractError').textContent = 'Tóm tắt không được vượt quá 300 từ';
                textarea.classList.add('is-invalid');
            } else {
                document.getElementById('abstractError').textContent = '';
                textarea.classList.remove('is-invalid');
            }
        }

        // Keywords management
        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const keyword = input.value.trim();
            
            if (!keyword) return;

            if (keywords.length >= 6) {
                alert('Tối đa 6 từ khóa');
                return;
            }

            if (keywords.includes(keyword)) {
                alert('Từ khóa đã tồn tại');
                return;
            }

            keywords.push(keyword);
            updateKeywordsDisplay();
            input.value = '';
        }

        function removeKeyword(button) {
            const keyword = button.closest('.badge').textContent.trim().replace('×', '').trim();
            keywords = keywords.filter(k => k !== keyword);
            updateKeywordsDisplay();
        }

        function updateKeywordsDisplay() {
            const container = document.getElementById('keywordsContainer');
            const hiddenInput = document.getElementById('keywordsInput');
            const countSpan = document.getElementById('keywordCount');

            if (keywords.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0 text-center py-2">Chưa có từ khóa nào</p>';
            } else {
                container.innerHTML = keywords.map(keyword => `
                    <span class="badge bg-primary me-2 mb-2" style="font-size: 0.875rem; padding: 0.5rem 0.75rem;">
                        ${keyword}
                        <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.6rem;" onclick="removeKeyword(this)"></button>
                    </span>
                `).join('');
            }

            hiddenInput.value = keywords.join(',');
            countSpan.textContent = keywords.length;
        }

        // Authors management
        function addAuthor() {
            const index = authors.length;
            authors.push({
                id: Date.now() + index,
                fullName: '',
                email: '',
                affiliation: '',
                isCorresponding: false
            });

            const container = document.getElementById('authorsContainer');
            const authorDiv = document.createElement('div');
            authorDiv.className = 'card mb-3 author-card';
            authorDiv.id = `author-${authors[authors.length - 1].id}`;
            authorDiv.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-user me-2 text-primary"></i>Tác giả ${authors.length}</h6>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="corresponding-${authors[authors.length - 1].id}" 
                                       onchange="toggleCorresponding(${authors[authors.length - 1].id})">
                                <label class="form-check-label" for="corresponding-${authors[authors.length - 1].id}">
                                    Tác giả chính
                                </label>
                            </div>
                            ${authors.length > 1 ? `<button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeAuthor(${authors[authors.length - 1].id})">
                                <i class="fas fa-times"></i>
                            </button>` : ''}
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control author-fullname" 
                                   placeholder="Nhập họ và tên" required 
                                   data-author-id="${authors[authors.length - 1].id}" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control author-email" 
                                   placeholder="email@example.com" required 
                                   data-author-id="${authors[authors.length - 1].id}" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Đơn vị</label>
                            <input type="text" class="form-control author-affiliation" 
                                   placeholder="Tên đơn vị công tác" 
                                   data-author-id="${authors[authors.length - 1].id}" />
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(authorDiv);

            // Add event listeners
            authorDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function() {
                    updateAuthorData(parseInt(this.dataset.authorId));
                });
            });
        }

        function removeAuthor(authorId) {
            if (authors.length <= 1) {
                alert('Phải có ít nhất một tác giả');
                return;
            }

            const author = authors.find(a => a.id === authorId);
            if (author && author.isCorresponding) {
                // If removing corresponding author, set first author as corresponding
                if (authors.length > 1) {
                    const firstAuthor = authors.find(a => a.id !== authorId);
                    if (firstAuthor) {
                        firstAuthor.isCorresponding = true;
                        document.getElementById(`corresponding-${firstAuthor.id}`).checked = true;
                    }
                }
            }

            authors = authors.filter(a => a.id !== authorId);
            document.getElementById(`author-${authorId}`).remove();
        }

        function toggleCorresponding(authorId) {
            const checkbox = document.getElementById(`corresponding-${authorId}`);
            const author = authors.find(a => a.id === authorId);
            
            if (checkbox.checked) {
                // Uncheck all other corresponding authors
                authors.forEach(a => {
                    if (a.id !== authorId) {
                        a.isCorresponding = false;
                        const otherCheckbox = document.getElementById(`corresponding-${a.id}`);
                        if (otherCheckbox) otherCheckbox.checked = false;
                    }
                });
                author.isCorresponding = true;
            } else {
                author.isCorresponding = false;
            }
        }

        function setFirstAuthorAsCorresponding() {
            if (authors.length > 0) {
                authors[0].isCorresponding = true;
                const checkbox = document.getElementById(`corresponding-${authors[0].id}`);
                if (checkbox) checkbox.checked = true;
            }
        }

        function updateAuthorData(authorId) {
            const author = authors.find(a => a.id === authorId);
            if (!author) return;

            const card = document.getElementById(`author-${authorId}`);
            author.fullName = card.querySelector('.author-fullname').value;
            author.email = card.querySelector('.author-email').value;
            author.affiliation = card.querySelector('.author-affiliation').value;
        }

        // File upload
        document.getElementById('fileInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                alert('File không được vượt quá 10MB');
                this.value = '';
                return;
            }

            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                <strong>${file.name}</strong>
                                <span class="text-muted ms-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        function removeFile() {
            document.getElementById('fileInput').value = '';
            document.getElementById('fileList').innerHTML = '';
        }

        // Auto-save
        function autoSave() {
            if (hasFormData()) {
                saveDraft(true); // true = auto save
            }
        }

        function saveDraft(isAuto = false) {
            const formData = collectFormData();
            
            // TODO: Send to server via AJAX
            // For now, just save to localStorage
            localStorage.setItem('submissionDraft', JSON.stringify(formData));
            lastSaveTime = new Date();

            if (!isAuto) {
                showAutoSaveMessage('Đã lưu nháp thành công!', 'success');
            } else {
                showAutoSaveMessage('Đã tự động lưu nháp', 'info');
            }
        }

        function collectFormData() {
            return {
                title: document.getElementById('titleInput')?.value || '',
                abstract: document.getElementById('abstractInput')?.value || '',
                keywords: keywords,
                topic: document.getElementById('topicSelect')?.value || '',
                authors: authors.map(a => ({
                    fullName: a.fullName,
                    email: a.email,
                    affiliation: a.affiliation,
                    isCorresponding: a.isCorresponding
                })),
                timestamp: new Date().toISOString()
            };
        }

        function hasFormData() {
            const title = document.getElementById('titleInput')?.value || '';
            const abstract = document.getElementById('abstractInput')?.value || '';
            return title.length > 0 || abstract.length > 0 || keywords.length > 0;
        }

        function showAutoSaveMessage(message, type = 'info') {
            const indicator = document.getElementById('autoSaveIndicator');
            const messageSpan = document.getElementById('autoSaveMessage');
            
            indicator.className = `alert alert-${type} alert-dismissible fade show`;
            messageSpan.textContent = message;
            indicator.style.display = 'block';

            setTimeout(() => {
                indicator.classList.remove('show');
                setTimeout(() => indicator.style.display = 'none', 150);
            }, 3000);
        }

        // Form validation
        function validateForm() {
            let isValid = true;

            // Validate title
            const title = document.getElementById('titleInput')?.value.trim();
            if (!title || title.length > 200) {
                document.getElementById('titleError').textContent = 'Tiêu đề là bắt buộc và không được vượt quá 200 ký tự';
                isValid = false;
            }

            // Validate abstract
            const abstract = document.getElementById('abstractInput')?.value.trim();
            const wordCount = abstract ? abstract.split(/\s+/).filter(w => w.length > 0).length : 0;
            if (!abstract || wordCount < 150 || wordCount > 300) {
                document.getElementById('abstractError').textContent = 'Tóm tắt phải từ 150-300 từ';
                isValid = false;
            }

            // Validate keywords
            if (keywords.length === 0 || keywords.length > 6) {
                document.getElementById('keywordsError').textContent = 'Phải có từ 1-6 từ khóa';
                isValid = false;
            }

            // Validate topic
            const topic = document.getElementById('topicSelect')?.value;
            if (!topic) {
                document.getElementById('topicError').textContent = 'Vui lòng chọn chủ đề';
                isValid = false;
            }

            // Validate authors
            const hasCorresponding = authors.some(a => a.isCorresponding);
            const allAuthorsValid = authors.every(a => a.fullName && a.email);
            
            if (authors.length === 0 || !allAuthorsValid) {
                document.getElementById('authorsError').textContent = 'Vui lòng điền đầy đủ thông tin tất cả tác giả';
                isValid = false;
            } else if (!hasCorresponding) {
                document.getElementById('authorsError').textContent = 'Phải có ít nhất một tác giả chính';
                isValid = false;
            }

            if (!isValid) {
                alert('Vui lòng kiểm tra lại các trường bắt buộc');
            }

            return isValid;
        }

        // Load draft on page load
        window.addEventListener('load', function() {
            const draft = localStorage.getItem('submissionDraft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    if (confirm('Bạn có muốn khôi phục bản nháp đã lưu không?')) {
                        loadDraft(data);
                    }
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            }
        });

        function loadDraft(data) {
            if (data.title) document.getElementById('titleInput').value = data.title;
            if (data.abstract) document.getElementById('abstractInput').value = data.abstract;
            if (data.topic) document.getElementById('topicSelect').value = data.topic;
            if (data.keywords && data.keywords.length > 0) {
                keywords = data.keywords;
                updateKeywordsDisplay();
            }
            if (data.authors && data.authors.length > 0) {
                // Clear existing authors
                authors = [];
                document.getElementById('authorsContainer').innerHTML = '';
                
                // Add authors from draft
                data.authors.forEach((authorData, index) => {
                    addAuthor();
                    const lastAuthor = authors[authors.length - 1];
                    lastAuthor.fullName = authorData.fullName || '';
                    lastAuthor.email = authorData.email || '';
                    lastAuthor.affiliation = authorData.affiliation || '';
                    lastAuthor.isCorresponding = authorData.isCorresponding || false;
                    
                    const card = document.getElementById(`author-${lastAuthor.id}`);
                    card.querySelector('.author-fullname').value = lastAuthor.fullName;
                    card.querySelector('.author-email').value = lastAuthor.email;
                    card.querySelector('.author-affiliation').value = lastAuthor.affiliation;
                    if (lastAuthor.isCorresponding) {
                        card.querySelector(`#corresponding-${lastAuthor.id}`).checked = true;
                    }
                });
            }
            
            updateTitleCounter();
            updateAbstractCounter();
        }
    </script>

    <style>
        .author-card {
            border-left: 3px solid var(--color-primary);
        }

        .file-upload-area {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--radius-lg);
            background: var(--color-gray-50);
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--color-primary);
            background: rgba(30, 64, 175, 0.05);
        }
    </style>
}
