@{
    ViewData["Title"] = "Submit Abstract";
    ViewData["HideMainHeader"] = true;
}
@await Html.PartialAsync("_AuthorNavHeader")

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="mb-4">
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-file-upload me-2"></i>Submit Abstract
                </h2>
                <p class="text-muted">Fill in all information to submit your paper abstract</p>
            </div>

            <!-- Auto-save Indicator -->
            <div id="autoSaveIndicator" class="alert alert-info alert-dismissible fade show" role="alert" style="display: none;">
                <i class="fas fa-save me-2"></i>
                <span id="autoSaveMessage">Auto-saving draft...</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Form -->
            <form id="submissionForm" asp-action="Create" method="post" enctype="multipart/form-data">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Paper Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Title -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-heading me-2 text-primary"></i>Title <span class="text-danger">*</span>
                            </label>
                            <input type="text" id="titleInput" name="Title" class="form-control form-control-lg" 
                                   placeholder="Enter paper title" maxlength="200" required />
                            <div class="d-flex justify-content-between mt-1">
                                <small class="form-text text-muted">Title should be concise and accurately describe the research content</small>
                                <small class="text-muted">
                                    <span id="titleCharCount">0</span>/200 characters
                                </small>
                            </div>
                            <span class="text-danger small" id="titleError"></span>
                        </div>

                        <!-- Abstract -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-align-left me-2 text-primary"></i>Abstract <span class="text-danger">*</span>
                            </label>
                            <textarea id="abstractInput" name="Abstract" class="form-control" rows="8" 
                                      placeholder="Enter paper abstract (150-300 words)" required></textarea>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="form-text text-muted">Abstract must be 150-300 words</small>
                                <small class="text-muted">
                                    <span id="abstractWordCount">0</span> words / 
                                    <span id="abstractCharCount">0</span> characters
                                </small>
                            </div>
                            <span class="text-danger small" id="abstractError"></span>
                        </div>

                        <!-- Keywords (Tag Input) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-tags me-2 text-primary"></i>Keywords <span class="text-danger">*</span>
                            </label>
                            <div id="keywordsContainer" class="mb-2 p-3 border rounded" style="min-height: 60px; background: var(--color-gray-50);">
                                <!-- Tags will be added here -->
                            </div>
                            <div class="input-group">
                                <input type="text" id="keywordInput" class="form-control" 
                                       placeholder="Enter keyword and press Enter (max 5-6 keywords)" 
                                       autocomplete="off" />
                                <button type="button" class="btn btn-outline-primary" onclick="addKeyword()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="form-text text-muted">Type keyword and press Enter to add. Maximum 5-6 keywords.</small>
                                <small class="text-muted">
                                    <span id="keywordCount">0</span>/6 keywords
                                </small>
                            </div>
                            <div id="keywordSuggestions" class="mt-2" style="display: none;">
                                <small class="text-muted"><i class="fas fa-lightbulb me-1"></i>Suggestions:</small>
                                <div id="suggestionsList" class="d-flex flex-wrap gap-2 mt-1"></div>
                            </div>
                            <input type="hidden" id="keywordsInput" name="Keywords" value="" />
                            <span class="text-danger small" id="keywordsError"></span>
                        </div>

                        <!-- Topic (Dropdown) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-list me-2 text-primary"></i>Topic <span class="text-danger">*</span>
                            </label>
                            <select id="topicSelect" name="TopicId" class="form-select form-select-lg" required>
                                <option value="">-- Select Topic --</option>
                                @if (ViewData["Topics"] != null)
                                {
                                    var topics = ViewData["Topics"] as List<SciSubmit.Models.Content.Topic>;
                                    var model = ViewData["Model"] as SciSubmit.Models.Submission.AbstractSubmissionViewModel;
                                    @foreach (var topic in topics ?? new List<SciSubmit.Models.Content.Topic>())
                                    {
                                        var isSelected = model != null && model.TopicId == topic.Id;
                                        <option value="@topic.Id" selected="@isSelected">@topic.Name</option>
                                    }
                                }
                            </select>
                            <small class="form-text text-muted mt-1"><i class="fas fa-info-circle me-1"></i>Topic is defined by Admin</small>
                            <span class="text-danger small" id="topicError"></span>
                        </div>

                        <!-- Authors (Dynamic) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-users me-2 text-primary"></i>Author Information <span class="text-danger">*</span>
                            </label>
                            <div id="authorsContainer">
                                <!-- Authors will be added here -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addAuthor()">
                                <i class="fas fa-plus me-1"></i>Add Author
                            </button>
                            <small class="form-text text-muted d-block mt-2"><i class="fas fa-info-circle me-1"></i>Must have at least one corresponding author</small>
                            <span class="text-danger small" id="authorsError"></span>
                        </div>

                        <!-- Optional File Upload -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-file-upload me-2 text-primary"></i>Support File (Optional)
                            </label>
                            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                                <div class="text-center py-4">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <h6>Drag and drop file here or click to select</h6>
                                    <p class="text-muted mb-0">DOC, DOCX (Max 10MB)</p>
                                </div>
                            </div>
                            <input type="file" id="fileInput" name="SupportFile" class="d-none" 
                                   accept=".doc,.docx" />
                            <div id="fileList" class="mt-3"></div>
                            <small class="form-text text-muted"><i class="fas fa-info-circle me-1"></i>Support file is optional</small>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow-sm border-0 mt-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-primary" id="btnSaveDraft" onclick="saveDraft()">
                                <i class="fas fa-save me-2"></i>Save Draft
                            </button>
                            <div class="ms-auto">
                                <a href="/Submission/Index" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">
                                    <i class="fas fa-paper-plane me-2"></i>Submit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Global variables
        let keywords = [];
        let authors = [];
        let autoSaveInterval;
        let lastSaveTime = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add first author by default
            addAuthor();
            setFirstAuthorAsCorresponding();

            // Character counters
            document.getElementById('titleInput')?.addEventListener('input', updateTitleCounter);
            document.getElementById('abstractInput')?.addEventListener('input', updateAbstractCounter);

            // Keyword input handlers
            document.getElementById('keywordInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addKeyword();
                }
            });

            document.getElementById('keywordInput')?.addEventListener('input', function() {
                // TODO: Show keyword suggestions from database
                // For now, just hide suggestions
                document.getElementById('keywordSuggestions').style.display = 'none';
            });

            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(autoSave, 30000);

            // Manual save draft button
            document.getElementById('btnSaveDraft')?.addEventListener('click', saveDraft);

            // Form submission - Convert to AJAX
            document.getElementById('submissionForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!validateForm()) {
                    return false;
                }

                const submitButton = document.getElementById('btnSubmit');
                const originalText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';

                try {
                    const formData = new FormData();
                    
                    // Add basic fields
                    formData.append('Title', document.getElementById('titleInput')?.value || '');
                    formData.append('Abstract', document.getElementById('abstractInput')?.value || '');
                    formData.append('TopicId', document.getElementById('topicSelect')?.value || '');
                    
                    // Add authors with indexed notation for model binding
                    authors.forEach((author, index) => {
                        formData.append(`Authors[${index}].FullName`, author.fullName || '');
                        formData.append(`Authors[${index}].Email`, author.email || '');
                        formData.append(`Authors[${index}].Affiliation`, author.affiliation || '');
                        formData.append(`Authors[${index}].IsCorrespondingAuthor`, author.isCorresponding ? 'true' : 'false');
                    });
                    
                    // Add keywords with indexed notation
                    keywords.forEach((keyword, index) => {
                        formData.append(`Keywords[${index}]`, keyword);
                    });
                    
                    // Add file if exists
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput?.files[0]) {
                        formData.append('SupportFile', fileInput.files[0]);
                    }
                    
                    // Get anti-forgery token
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    if (token) {
                        formData.append('__RequestVerificationToken', token);
                    }

                    const response = await fetch('@Url.Action("Submit", "Submission")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert(result.message || 'Submission successful!');
                        window.location.href = '@Url.Action("Index", "Submission")';
                    } else {
                        alert('Error: ' + (result.errors?.join(', ') || result.message || 'Unable to submit'));
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    alert('An error occurred while submitting. Please try again.');
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        });

        // Title character counter
        function updateTitleCounter() {
            const input = document.getElementById('titleInput');
            const count = input.value.length;
            document.getElementById('titleCharCount').textContent = count;
            
            if (count > 200) {
                document.getElementById('titleError').textContent = 'Title cannot exceed 200 characters';
                input.classList.add('is-invalid');
            } else {
                document.getElementById('titleError').textContent = '';
                input.classList.remove('is-invalid');
            }
        }

        // Abstract word/character counter
        function updateAbstractCounter() {
            const textarea = document.getElementById('abstractInput');
            const text = textarea.value.trim();
            const words = text ? text.split(/\s+/).filter(w => w.length > 0) : [];
            const wordCount = words.length;
            const charCount = text.length;

            document.getElementById('abstractWordCount').textContent = wordCount;
            document.getElementById('abstractCharCount').textContent = charCount;

            if (wordCount < 150) {
                document.getElementById('abstractError').textContent = 'Abstract must have at least 150 words';
                textarea.classList.add('is-invalid');
            } else if (wordCount > 300) {
                document.getElementById('abstractError').textContent = 'Abstract cannot exceed 300 words';
                textarea.classList.add('is-invalid');
            } else {
                document.getElementById('abstractError').textContent = '';
                textarea.classList.remove('is-invalid');
            }
        }

        // Keywords management
        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const keyword = input.value.trim();
            
            if (!keyword) return;

            if (keywords.length >= 6) {
                alert('Maximum 6 keywords');
                return;
            }

            if (keywords.includes(keyword)) {
                alert('Keyword already exists');
                return;
            }

            keywords.push(keyword);
            updateKeywordsDisplay();
            input.value = '';
        }

        function removeKeyword(button) {
            const keyword = button.closest('.badge').textContent.trim().replace('Ã—', '').trim();
            keywords = keywords.filter(k => k !== keyword);
            updateKeywordsDisplay();
        }

        function updateKeywordsDisplay() {
            const container = document.getElementById('keywordsContainer');
            const hiddenInput = document.getElementById('keywordsInput');
            const countSpan = document.getElementById('keywordCount');

            if (keywords.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0 text-center py-2"><i class="fas fa-info-circle me-1"></i>No keywords added yet</p>';
            } else {
                container.innerHTML = keywords.map(keyword => `
                    <span class="badge bg-primary me-2 mb-2" style="font-size: 0.875rem; padding: 0.5rem 0.75rem;">
                        ${keyword}
                        <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.6rem;" onclick="removeKeyword(this)"></button>
                    </span>
                `).join('');
            }

            hiddenInput.value = keywords.join(',');
            countSpan.textContent = keywords.length;
        }

        // Authors management
        function addAuthor() {
            const index = authors.length;
            authors.push({
                id: Date.now() + index,
                fullName: '',
                email: '',
                affiliation: '',
                isCorresponding: false
            });

            const container = document.getElementById('authorsContainer');
            const authorDiv = document.createElement('div');
            authorDiv.className = 'card mb-3 author-card';
            authorDiv.id = `author-${authors[authors.length - 1].id}`;
            authorDiv.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-user me-2 text-primary"></i>Author ${authors.length}</h6>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="corresponding-${authors[authors.length - 1].id}" 
                                       onchange="toggleCorresponding(${authors[authors.length - 1].id})">
                                <label class="form-check-label" for="corresponding-${authors[authors.length - 1].id}">
                                    <i class="fas fa-star me-1 text-warning"></i>Corresponding Author
                                </label>
                            </div>
                            ${authors.length > 1 ? `<button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeAuthor(${authors[authors.length - 1].id})">
                                <i class="fas fa-times"></i>
                            </button>` : ''}
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label"><i class="fas fa-user me-1"></i>Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control author-fullname" 
                                   placeholder="Enter full name" required 
                                   data-author-id="${authors[authors.length - 1].id}" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"><i class="fas fa-envelope me-1"></i>Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control author-email" 
                                   placeholder="email@example.com" required 
                                   data-author-id="${authors[authors.length - 1].id}" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"><i class="fas fa-building me-1"></i>Affiliation</label>
                            <input type="text" class="form-control author-affiliation" 
                                   placeholder="Organization/Institution" 
                                   data-author-id="${authors[authors.length - 1].id}" />
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(authorDiv);

            // Add event listeners
            authorDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function() {
                    updateAuthorData(parseInt(this.dataset.authorId));
                });
            });
        }

        function removeAuthor(authorId) {
            if (authors.length <= 1) {
                alert('Must have at least one author');
                return;
            }

            const author = authors.find(a => a.id === authorId);
            if (author && author.isCorresponding) {
                // If removing corresponding author, set first author as corresponding
                if (authors.length > 1) {
                    const firstAuthor = authors.find(a => a.id !== authorId);
                    if (firstAuthor) {
                        firstAuthor.isCorresponding = true;
                        document.getElementById(`corresponding-${firstAuthor.id}`).checked = true;
                    }
                }
            }

            authors = authors.filter(a => a.id !== authorId);
            document.getElementById(`author-${authorId}`).remove();
        }

        function toggleCorresponding(authorId) {
            const checkbox = document.getElementById(`corresponding-${authorId}`);
            const author = authors.find(a => a.id === authorId);
            
            if (checkbox.checked) {
                // Uncheck all other corresponding authors
                authors.forEach(a => {
                    if (a.id !== authorId) {
                        a.isCorresponding = false;
                        const otherCheckbox = document.getElementById(`corresponding-${a.id}`);
                        if (otherCheckbox) otherCheckbox.checked = false;
                    }
                });
                author.isCorresponding = true;
            } else {
                author.isCorresponding = false;
            }
        }

        function setFirstAuthorAsCorresponding() {
            if (authors.length > 0) {
                authors[0].isCorresponding = true;
                const checkbox = document.getElementById(`corresponding-${authors[0].id}`);
                if (checkbox) checkbox.checked = true;
            }
        }

        function updateAuthorData(authorId) {
            const author = authors.find(a => a.id === authorId);
            if (!author) return;

            const card = document.getElementById(`author-${authorId}`);
            author.fullName = card.querySelector('.author-fullname').value;
            author.email = card.querySelector('.author-email').value;
            author.affiliation = card.querySelector('.author-affiliation').value;
        }

        // File upload
        document.getElementById('fileInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type (only DOC/DOCX)
            const allowedExtensions = ['.doc', '.docx'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                alert('Only DOC or DOCX files are accepted');
                this.value = '';
                return;
            }

            // Validate file size
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must not exceed 10MB');
                this.value = '';
                return;
            }

            const fileListDiv = document.getElementById('fileList');
            const fileIcon = fileExtension === '.docx' ? 'fa-file-word text-primary' : 'fa-file-alt text-primary';
            fileListDiv.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas ${fileIcon} me-2"></i>
                                <strong>${file.name}</strong>
                                <span class="text-muted ms-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        function removeFile() {
            document.getElementById('fileInput').value = '';
            document.getElementById('fileList').innerHTML = '';
        }

        // Auto-save
        function autoSave() {
            if (hasFormData()) {
                saveDraft(true); // true = auto save
            }
        }

        async function saveDraft(isAuto = false) {
            const formDataObj = collectFormData();
            
            // Also save to localStorage as backup
            localStorage.setItem('submissionDraft', JSON.stringify(formDataObj));
            
            // Send to server via AJAX
            try {
                const formData = new FormData();
                formData.append('Title', formDataObj.title);
                formData.append('Abstract', formDataObj.abstract);
                formData.append('TopicId', formDataObj.topicId);
                formData.append('Keywords', JSON.stringify(formDataObj.keywords));
                formData.append('Authors', JSON.stringify(formDataObj.authors));
                formData.append('IsDraft', 'true');
                
                // Add file if exists
                const fileInput = document.getElementById('fileInput');
                if (fileInput?.files[0]) {
                    formData.append('SupportFile', fileInput.files[0]);
                }

                const response = await fetch('@Url.Action("SaveDraft", "Submission")', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    lastSaveTime = new Date();
                    if (!isAuto) {
                        showAutoSaveMessage('Draft saved successfully!', 'success');
                    } else {
                        showAutoSaveMessage('Auto-saved draft', 'info');
                    }
                    console.log('Draft saved to server. SubmissionId:', result.submissionId);
                } else {
                    console.error('Error saving draft:', result.errors);
                    if (!isAuto) {
                        showAutoSaveMessage('Error saving draft', 'danger');
                    }
                }
            } catch (error) {
                console.error('Error saving draft:', error);
                // Still save to localStorage even if server fails
                lastSaveTime = new Date();
                if (!isAuto) {
                    showAutoSaveMessage('Draft saved locally (server error)', 'warning');
                }
            }
        }

        function collectFormData() {
            return {
                title: document.getElementById('titleInput')?.value || '',
                abstract: document.getElementById('abstractInput')?.value || '',
                keywords: keywords,
                topicId: parseInt(document.getElementById('topicSelect')?.value || '0'),
                authors: authors.map(a => ({
                    fullName: a.fullName,
                    email: a.email,
                    affiliation: a.affiliation,
                    isCorresponding: a.isCorresponding
                })),
                timestamp: new Date().toISOString()
            };
        }

        function hasFormData() {
            const title = document.getElementById('titleInput')?.value || '';
            const abstract = document.getElementById('abstractInput')?.value || '';
            return title.length > 0 || abstract.length > 0 || keywords.length > 0;
        }

        function showAutoSaveMessage(message, type = 'info') {
            const indicator = document.getElementById('autoSaveIndicator');
            const messageSpan = document.getElementById('autoSaveMessage');
            
            indicator.className = `alert alert-${type} alert-dismissible fade show`;
            messageSpan.textContent = message;
            indicator.style.display = 'block';

            setTimeout(() => {
                indicator.classList.remove('show');
                setTimeout(() => indicator.style.display = 'none', 150);
            }, 3000);
        }

        // Form validation
        function validateForm() {
            let isValid = true;

            // Validate title
            const title = document.getElementById('titleInput')?.value.trim();
            if (!title || title.length > 200) {
                document.getElementById('titleError').textContent = 'Title is required and cannot exceed 200 characters';
                isValid = false;
            }

            // Validate abstract
            const abstract = document.getElementById('abstractInput')?.value.trim();
            const wordCount = abstract ? abstract.split(/\s+/).filter(w => w.length > 0).length : 0;
            if (!abstract || wordCount < 150 || wordCount > 300) {
                document.getElementById('abstractError').textContent = 'Abstract must be 150-300 words';
                isValid = false;
            }

            // Validate keywords
            if (keywords.length === 0 || keywords.length > 6) {
                document.getElementById('keywordsError').textContent = 'Must have 1-6 keywords';
                isValid = false;
            }

            // Validate topic
            const topicId = parseInt(document.getElementById('topicSelect')?.value || '0');
            if (!topicId || topicId === 0) {
                document.getElementById('topicError').textContent = 'Please select a topic';
                isValid = false;
            }

            // Validate authors
            const hasCorresponding = authors.some(a => a.isCorresponding);
            const allAuthorsValid = authors.every(a => a.fullName && a.email);
            
            if (authors.length === 0 || !allAuthorsValid) {
                document.getElementById('authorsError').textContent = 'Please fill in all author information';
                isValid = false;
            } else if (!hasCorresponding) {
                document.getElementById('authorsError').textContent = 'Must have at least one corresponding author';
                isValid = false;
            }

            if (!isValid) {
                alert('Please check all required fields');
            }

            return isValid;
        }

        // Load draft on page load
        window.addEventListener('load', function() {
            const draft = localStorage.getItem('submissionDraft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    if (confirm('Do you want to restore the saved draft?')) {
                        loadDraft(data);
                    }
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            }
        });

        function loadDraft(data) {
            if (data.title) document.getElementById('titleInput').value = data.title;
            if (data.abstract) document.getElementById('abstractInput').value = data.abstract;
            if (data.topicId) document.getElementById('topicSelect').value = data.topicId;
            if (data.keywords && data.keywords.length > 0) {
                keywords = data.keywords;
                updateKeywordsDisplay();
            }
            if (data.authors && data.authors.length > 0) {
                // Clear existing authors
                authors = [];
                document.getElementById('authorsContainer').innerHTML = '';
                
                // Add authors from draft
                data.authors.forEach((authorData, index) => {
                    addAuthor();
                    const lastAuthor = authors[authors.length - 1];
                    lastAuthor.fullName = authorData.fullName || '';
                    lastAuthor.email = authorData.email || '';
                    lastAuthor.affiliation = authorData.affiliation || '';
                    lastAuthor.isCorresponding = authorData.isCorresponding || false;
                    
                    const card = document.getElementById(`author-${lastAuthor.id}`);
                    card.querySelector('.author-fullname').value = lastAuthor.fullName;
                    card.querySelector('.author-email').value = lastAuthor.email;
                    card.querySelector('.author-affiliation').value = lastAuthor.affiliation;
                    if (lastAuthor.isCorresponding) {
                        card.querySelector(`#corresponding-${lastAuthor.id}`).checked = true;
                    }
                });
            }
            
            updateTitleCounter();
            updateAbstractCounter();
        }
    </script>

    <style>
        .author-card {
            border-left: 3px solid var(--color-primary);
        }

        .file-upload-area {
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--radius-lg);
            background: var(--color-gray-50);
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--color-primary);
            background: rgba(30, 64, 175, 0.05);
        }
    </style>
}
