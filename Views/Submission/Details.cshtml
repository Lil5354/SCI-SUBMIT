@{
    ViewData["Title"] = "Submission Details";
    ViewData["HideMainHeader"] = true;
    var submissionId = ViewData["SubmissionId"] ?? 0;
    var submission = ViewData["Submission"] as SciSubmit.Models.Submission.Submission;
}
@await Html.PartialAsync("_AuthorNavHeader")

@Html.AntiForgeryToken()

<div class="container my-5">
    <!-- Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-file-alt me-2"></i>Submission Details
                </h2>
                <p class="text-muted mb-0">Detailed information and status of your paper</p>
            </div>
            <div>
                <a href="/Submission/Index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Submission Info Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Paper Information</h5>
                </div>
                <div class="card-body">
                    @if (submission != null)
                    {
                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted">Title</label>
                            <h5 class="mb-0">@submission.Title</h5>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted">Abstract</label>
                            <p class="mb-0">@submission.Abstract</p>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-muted">Topic</label>
                                <div>
                                    @foreach (var topic in submission.SubmissionTopics.Select(st => st.Topic))
                                    {
                                        <span class="badge bg-info me-1">@topic?.Name</span>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-muted">Keywords</label>
                                <div>
                                    @foreach (var keyword in submission.SubmissionKeywords.Select(sk => sk.Keyword))
                                    {
                                        <span class="badge bg-primary me-1">@keyword?.Name</span>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted">Authors</label>
                            <ul class="list-unstyled mb-0">
                                @foreach (var author in submission.SubmissionAuthors.OrderBy(a => a.OrderIndex))
                                {
                                    <li class="mb-2">
                                        <i class="fas fa-user me-2 text-primary"></i>
                                        <strong>@author.FullName</strong>
                                        @if (author.IsCorrespondingAuthor)
                                        {
                                            <span class="badge bg-success ms-2">Corresponding Author</span>
                                        }
                                        <br>
                                        <small class="text-muted ms-4">@author.Email @if (!string.IsNullOrEmpty(author.Affiliation)) { <text>| @author.Affiliation</text> }</small>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>

            <!-- Timeline Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>History and Status</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item completed">
                            <div class="timeline-marker bg-success">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Abstract Submitted</h6>
                                <p class="text-muted mb-1 small">@(submission?.AbstractSubmittedAt?.ToString("dd/MM/yyyy HH:mm") ?? submission?.CreatedAt.ToString("dd/MM/yyyy HH:mm") ?? "")</p>
                            </div>
                        </div>
                        @if (submission != null && submission.Status == SciSubmit.Models.Enums.SubmissionStatus.AbstractApproved)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker bg-success">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Abstract Approved</h6>
                                    <p class="text-muted mb-1 small">@(submission.AbstractReviewedAt?.ToString("dd/MM/yyyy HH:mm") ?? "")</p>
                                </div>
                            </div>
                            <div class="timeline-item active">
                                <div class="timeline-marker bg-primary">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Awaiting Full Paper Submission</h6>
                                    <p class="text-muted mb-1 small">Current Status</p>
                                </div>
                            </div>
                        }
                        else if (submission != null && submission.Status == SciSubmit.Models.Enums.SubmissionStatus.PendingAbstractReview)
                        {
                            <div class="timeline-item active">
                                <div class="timeline-marker bg-warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Pending Abstract Review</h6>
                                    <p class="text-muted mb-1 small">Current Status</p>
                                </div>
                            </div>
                        }
                        else if (submission != null && submission.Status == SciSubmit.Models.Enums.SubmissionStatus.AbstractRejected)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker bg-danger">
                                    <i class="fas fa-times"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Abstract Rejected</h6>
                                    <p class="text-muted mb-1 small">@(submission.AbstractReviewedAt?.ToString("dd/MM/yyyy HH:mm") ?? "")</p>
                                </div>
                            </div>
                        }
                        <div class="timeline-item">
                            <div class="timeline-marker bg-gray">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Under Review</h6>
                                <p class="text-muted mb-1 small">Not Started</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-gray">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Payment</h6>
                                <p class="text-muted mb-1 small">Not Started</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Files Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-file me-2"></i>Uploaded Files</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        @if (submission != null && !string.IsNullOrEmpty(submission.AbstractFileUrl))
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-word text-primary me-2"></i>
                                        <strong>@System.IO.Path.GetFileName(submission.AbstractFileUrl)</strong>
                                        <br>
                                        <small class="text-muted">Uploaded at: @(submission.AbstractSubmittedAt?.ToString("dd/MM/yyyy HH:mm") ?? submission.CreatedAt.ToString("dd/MM/yyyy HH:mm"))</small>
                                    </div>
                                    <a href="@submission.AbstractFileUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="list-group-item text-center text-muted">
                                <i class="fas fa-file me-2"></i>No files uploaded yet
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Review Results Card -->
            @{
                var reviewResults = ViewData["ReviewResults"] as IEnumerable<SciSubmit.Models.Review.Review>;
                var reviewCriterias = ViewData["ReviewCriterias"] as Dictionary<string, int> ?? new Dictionary<string, int>();
            }
            @if (submission != null && reviewResults != null && reviewResults.Any())
            {
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Review Results</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var review in reviewResults)
                        {
                            <div class="review-result-card mb-4 p-4 border rounded" style="background-color: #f8f9fa;">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-user-tie me-2 text-primary"></i>
                                            <strong>Reviewer: @(review.Reviewer?.FullName ?? "N/A")</strong>
                                        </h6>
                                        <small class="text-muted">@(review.Reviewer?.Email ?? "N/A")</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="mb-1">
                                            <span class="badge bg-primary fs-6">
                                                Average Score: @(review.AverageScore?.ToString("F2") ?? "N/A")
                                            </span>
                                        </div>
                                        <small class="text-muted">
                                            Submitted: @review.SubmittedAt.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    </div>
                                </div>

                                @if (review.ReviewScores.Any())
                                {
                                    <div class="mb-3">
                                        <h6 class="mb-2"><i class="fas fa-chart-bar me-2"></i>Detailed Scores:</h6>
                                        <div class="row g-2">
                                            @foreach (var score in review.ReviewScores)
                                            {
                                                var maxScore = reviewCriterias.GetValueOrDefault(score.CriteriaName, 5);
                                                <div class="col-md-6">
                                                    <div class="d-flex justify-content-between align-items-center p-2 bg-white rounded">
                                                        <span class="small">@score.CriteriaName:</span>
                                                        <span class="badge bg-info">
                                                            @score.Score / @maxScore
                                                        </span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(review.Recommendation))
                                {
                                    <div class="mb-3">
                                        <h6 class="mb-2"><i class="fas fa-gavel me-2"></i>Recommendation:</h6>
                                        @{
                                            var recommendationBadgeClass = review.Recommendation switch
                                            {
                                                "Accept" => "bg-success",
                                                "MinorRevision" => "bg-warning",
                                                "MajorRevision" => "bg-warning",
                                                "Reject" => "bg-danger",
                                                _ => "bg-secondary"
                                            };
                                        }
                                        <span class="badge @recommendationBadgeClass fs-6 px-3 py-2">@review.Recommendation</span>
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(review.CommentsForAuthor))
                                {
                                    <div class="mb-3">
                                        <h6 class="mb-2"><i class="fas fa-comment-dots me-2 text-info"></i>Reviewer Comments:</h6>
                                        <div class="p-3 bg-white rounded border">
                                            <p class="mb-0">@review.CommentsForAuthor</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Status Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Status</h6>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        @if (submission != null)
                        {
                            @if (submission.Status == SciSubmit.Models.Enums.SubmissionStatus.PendingAbstractReview)
                            {
                                <span class="badge bg-warning fs-6 px-4 py-2">Pending Abstract Review</span>
                                <p class="text-muted small mb-0 mt-2">Your abstract is under review. Please wait for notification.</p>
                            }
                            else if (submission.Status == SciSubmit.Models.Enums.SubmissionStatus.AbstractApproved)
                            {
                                <span class="badge bg-success fs-6 px-4 py-2">Abstract Approved</span>
                                <p class="text-muted small mb-0 mt-2">Your paper has passed step 1. You can now submit the full paper.</p>
                            }
                            else if (submission.Status == SciSubmit.Models.Enums.SubmissionStatus.AbstractRejected)
                            {
                                <span class="badge bg-danger fs-6 px-4 py-2">Abstract Rejected</span>
                                <p class="text-muted small mb-0 mt-2">Your abstract has been rejected. Please review the reason and revise.</p>
                            }
                            else
                            {
                                <span class="badge bg-info fs-6 px-4 py-2">@submission.Status.ToString()</span>
                            }
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>Submission information not found.
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/Submission/FullPaper/@submissionId" class="btn btn-primary">
                            <i class="fas fa-file-pdf me-2"></i>Submit Full Paper
                        </a>
                        <button class="btn btn-outline-secondary" onclick="downloadSubmission()">
                            <i class="fas fa-download me-2"></i>Download
                        </button>
                        <button class="btn btn-outline-danger" onclick="withdrawSubmission()">
                            <i class="fas fa-times me-2"></i>Withdraw
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Information</h6>
                </div>
                <div class="card-body">
                    @if (submission != null)
                    {
                        <p class="small text-muted mb-2">
                            <i class="fas fa-calendar me-2"></i>
                            <strong>Submitted Date:</strong> @(submission.AbstractSubmittedAt?.ToString("dd/MM/yyyy") ?? submission.CreatedAt.ToString("dd/MM/yyyy"))
                        </p>
                        <p class="small text-muted mb-0">
                            <i class="fas fa-id-badge me-2"></i>
                            <strong>Submission ID:</strong> #@submission.Id
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function getToken() {
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            return token ? token.value : '';
        }
        
        function downloadSubmission() {
            // Get submission ID from view data
            const submissionId = @submissionId;
            
            // Show loading
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Downloading...';
            
            // Redirect to download endpoint
            window.location.href = '/Submission/Download/' + submissionId;
            
            // Re-enable button after a short delay (in case download fails)
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }, 2000);
        }

        function withdrawSubmission() {
            if (confirm('Are you sure you want to withdraw this submission? This action cannot be undone.')) {
                // Get submission ID from view data
                const submissionId = @submissionId;
                
                // Show loading
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                
                // Get antiforgery token
                const token = getToken();
                
                // Create form data
                const formData = new FormData();
                formData.append('id', submissionId);
                formData.append('__RequestVerificationToken', token);
                
                // Send POST request
                fetch('/Submission/Withdraw', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': token
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // Redirect to index page (success)
                        window.location.href = response.url;
                    } else {
                        return response.text();
                    }
                })
                .then(data => {
                    if (data) {
                        // If there's an error, show it
                        alert('Error: ' + data);
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while withdrawing the submission. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
            }
        }
    </script>

    <style>
        .timeline {
            position: relative;
            padding-left: 2.5rem;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
        }

        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 2rem;
            width: 2px;
            height: calc(100% - 0.5rem);
            background: var(--color-gray-300);
        }

        .timeline-marker {
            position: absolute;
            left: -2.5rem;
            top: 0;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            border: 3px solid var(--color-white);
            box-shadow: 0 0 0 2px var(--color-gray-300);
        }

        .timeline-item.completed .timeline-marker {
            background: var(--color-success);
            box-shadow: 0 0 0 2px var(--color-success);
        }

        .timeline-item.active .timeline-marker {
            background: var(--color-primary);
            box-shadow: 0 0 0 2px var(--color-primary);
            animation: pulse 2s infinite;
        }

        .timeline-item .timeline-marker.bg-gray {
            background: var(--color-gray-400);
            box-shadow: 0 0 0 2px var(--color-gray-400);
        }

        @@keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
}
