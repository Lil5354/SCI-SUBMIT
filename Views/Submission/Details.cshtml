@{
    ViewData["Title"] = "Submission Details";
    ViewData["HideMainHeader"] = true;
    var submissionId = ViewData["SubmissionId"] ?? 0;
    var submission = ViewData["Submission"] as SciSubmit.Models.Submission.Submission;
}
@await Html.PartialAsync("_AuthorNavHeader")

<div class="container my-5">
    <!-- Header -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-file-alt me-2"></i>Submission Details
                </h2>
                <p class="text-muted mb-0">Detailed information and status of your paper</p>
            </div>
            <div>
                <a href="/Submission/Index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Submission Info Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Paper Information</h5>
                </div>
                <div class="card-body">
                    @if (submission != null)
                    {
                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted">Title</label>
                            <h5 class="mb-0">@submission.Title</h5>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted">Abstract</label>
                            <p class="mb-0">@submission.Abstract</p>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-muted">Topic</label>
                                <div>
                                    @foreach (var topic in submission.SubmissionTopics.Select(st => st.Topic))
                                    {
                                        <span class="badge bg-info me-1">@topic?.Name</span>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-muted">Keywords</label>
                                <div>
                                    @foreach (var keyword in submission.SubmissionKeywords.Select(sk => sk.Keyword))
                                    {
                                        <span class="badge bg-primary me-1">@keyword?.Name</span>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted">Authors</label>
                            <ul class="list-unstyled mb-0">
                                @foreach (var author in submission.SubmissionAuthors.OrderBy(a => a.OrderIndex))
                                {
                                    <li class="mb-2">
                                        <i class="fas fa-user me-2 text-primary"></i>
                                        <strong>@author.FullName</strong>
                                        @if (author.IsCorrespondingAuthor)
                                        {
                                            <span class="badge bg-success ms-2">Corresponding Author</span>
                                        }
                                        <br>
                                        <small class="text-muted ms-4">@author.Email @if (!string.IsNullOrEmpty(author.Affiliation)) { <text>| @author.Affiliation</text> }</small>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>

            <!-- Timeline Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>History and Status</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item completed">
                            <div class="timeline-marker bg-success">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Abstract Submitted</h6>
                                <p class="text-muted mb-1 small">@(submission?.AbstractSubmittedAt?.ToString("dd/MM/yyyy HH:mm") ?? submission?.CreatedAt.ToString("dd/MM/yyyy HH:mm") ?? "")</p>
                            </div>
                        </div>
                        @if (submission != null && submission.Status == SciSubmit.Models.Enums.SubmissionStatus.AbstractApproved)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker bg-success">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Abstract Approved</h6>
                                    <p class="text-muted mb-1 small">@(submission.AbstractReviewedAt?.ToString("dd/MM/yyyy HH:mm") ?? "")</p>
                                </div>
                            </div>
                            <div class="timeline-item active">
                                <div class="timeline-marker bg-primary">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Awaiting Full Paper Submission</h6>
                                    <p class="text-muted mb-1 small">Current Status</p>
                                </div>
                            </div>
                        }
                        else if (submission != null && submission.Status == SciSubmit.Models.Enums.SubmissionStatus.PendingAbstractReview)
                        {
                            <div class="timeline-item active">
                                <div class="timeline-marker bg-warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Pending Abstract Review</h6>
                                    <p class="text-muted mb-1 small">Current Status</p>
                                </div>
                            </div>
                        }
                        else if (submission != null && submission.Status == SciSubmit.Models.Enums.SubmissionStatus.AbstractRejected)
                        {
                            <div class="timeline-item completed">
                                <div class="timeline-marker bg-danger">
                                    <i class="fas fa-times"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Abstract Rejected</h6>
                                    <p class="text-muted mb-1 small">@(submission.AbstractReviewedAt?.ToString("dd/MM/yyyy HH:mm") ?? "")</p>
                                </div>
                            </div>
                        }
                        <div class="timeline-item">
                            <div class="timeline-marker bg-gray">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Under Review</h6>
                                <p class="text-muted mb-1 small">Not Started</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-gray">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Payment</h6>
                                <p class="text-muted mb-1 small">Not Started</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Files Card -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-file me-2"></i>Uploaded Files</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        @if (submission != null && !string.IsNullOrEmpty(submission.AbstractFileUrl))
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-file-word text-primary me-2"></i>
                                        <strong>@System.IO.Path.GetFileName(submission.AbstractFileUrl)</strong>
                                        <br>
                                        <small class="text-muted">Uploaded at: @(submission.AbstractSubmittedAt?.ToString("dd/MM/yyyy HH:mm") ?? submission.CreatedAt.ToString("dd/MM/yyyy HH:mm"))</small>
                                    </div>
                                    <a href="@submission.AbstractFileUrl" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="list-group-item text-center text-muted">
                                <i class="fas fa-file me-2"></i>No files uploaded yet
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Status Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Status</h6>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        @if (submission != null)
                        {
                            @if (submission.Status == SciSubmit.Models.Enums.SubmissionStatus.PendingAbstractReview)
                            {
                                <span class="badge bg-warning fs-6 px-4 py-2">Pending Abstract Review</span>
                                <p class="text-muted small mb-0 mt-2">Your abstract is under review. Please wait for notification.</p>
                            }
                            else if (submission.Status == SciSubmit.Models.Enums.SubmissionStatus.AbstractApproved)
                            {
                                <span class="badge bg-success fs-6 px-4 py-2">Abstract Approved</span>
                                <p class="text-muted small mb-0 mt-2">Your paper has passed step 1. You can now submit the full paper.</p>
                            }
                            else if (submission.Status == SciSubmit.Models.Enums.SubmissionStatus.AbstractRejected)
                            {
                                <span class="badge bg-danger fs-6 px-4 py-2">Abstract Rejected</span>
                                <p class="text-muted small mb-0 mt-2">Your abstract has been rejected. Please review the reason and revise.</p>
                            }
                            else
                            {
                                <span class="badge bg-info fs-6 px-4 py-2">@submission.Status.ToString()</span>
                            }
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>Submission information not found.
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/Submission/FullPaper/@submissionId" class="btn btn-primary">
                            <i class="fas fa-file-pdf me-2"></i>Nộp bài đầy đủ
                        </a>
                        <button class="btn btn-outline-secondary" onclick="downloadSubmission()">
                            <i class="fas fa-download me-2"></i>Tải xuống
                        </button>
                        <button class="btn btn-outline-danger" onclick="withdrawSubmission()">
                            <i class="fas fa-times me-2"></i>Rút bài
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info Card -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Information</h6>
                </div>
                <div class="card-body">
                    @if (submission != null)
                    {
                        <p class="small text-muted mb-2">
                            <i class="fas fa-calendar me-2"></i>
                            <strong>Submitted Date:</strong> @(submission.AbstractSubmittedAt?.ToString("dd/MM/yyyy") ?? submission.CreatedAt.ToString("dd/MM/yyyy"))
                        </p>
                        <p class="small text-muted mb-0">
                            <i class="fas fa-id-badge me-2"></i>
                            <strong>Submission ID:</strong> #@submission.Id
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function downloadSubmission() {
            // TODO: Implement download
            alert('Download feature is under development');
        }

        function withdrawSubmission() {
            if (confirm('Are you sure you want to withdraw this submission?')) {
                // TODO: Implement withdraw
                alert('Withdrawal feature is under development');
            }
        }
    </script>

    <style>
        .timeline {
            position: relative;
            padding-left: 2.5rem;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
        }

        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 2rem;
            width: 2px;
            height: calc(100% - 0.5rem);
            background: var(--color-gray-300);
        }

        .timeline-marker {
            position: absolute;
            left: -2.5rem;
            top: 0;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            border: 3px solid var(--color-white);
            box-shadow: 0 0 0 2px var(--color-gray-300);
        }

        .timeline-item.completed .timeline-marker {
            background: var(--color-success);
            box-shadow: 0 0 0 2px var(--color-success);
        }

        .timeline-item.active .timeline-marker {
            background: var(--color-primary);
            box-shadow: 0 0 0 2px var(--color-primary);
            animation: pulse 2s infinite;
        }

        .timeline-item .timeline-marker.bg-gray {
            background: var(--color-gray-400);
            box-shadow: 0 0 0 2px var(--color-gray-400);
        }

        @@keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
}
