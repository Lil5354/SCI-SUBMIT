@{
    ViewData["Title"] = "Payment - Submit Full Paper";
    ViewData["HideMainHeader"] = true;
    var submission = ViewData["Submission"] as SciSubmit.Models.Submission.Submission;
    var submissionId = ViewData["SubmissionId"] ?? 0;
}
@await Html.PartialAsync("_AuthorNavHeader")

@Html.AntiForgeryToken()

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="mb-4 text-center">
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-credit-card me-2"></i>Payment Required
                </h2>
                <p class="text-muted">Complete payment to proceed with full paper submission</p>
            </div>

            <!-- Important Notice -->
            <div class="alert alert-warning mb-4">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Important Notice</h5>
                <p class="mb-0">
                    To submit your full paper, you must complete the payment of the conference registration fee. 
                    After payment confirmation, you will be able to upload your full paper file.
                </p>
            </div>

            @if (submission != null)
            {
                <!-- Submission Info Card -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Submission Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-muted">Paper Title</label>
                                <p class="mb-0">@submission.Title</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-muted">Submission ID</label>
                                <p class="mb-0">#@submission.Id</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted">Abstract</label>
                            <div class="p-3 bg-light rounded" style="max-height: 150px; overflow-y: auto;">
                                <p class="mb-0 small">@submission.Abstract</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Amount Card -->
                <div class="card shadow-sm border-0 mb-4 border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Payment Amount</h5>
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-success mb-3">2,000,000 VNĐ</h2>
                        <p class="text-muted mb-0">Conference Registration Fee</p>
                    </div>
                </div>

                <!-- Bank Transfer Information -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-university me-2"></i>Bank Transfer Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Bank Name</label>
                                <p class="mb-0">Vietcombank</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Account Number</label>
                                <p class="mb-0"><strong class="text-primary">1234567890</strong></p>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Account Holder</label>
                                <p class="mb-0">Conference Organizing Committee</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Transfer Content</label>
                                <p class="mb-0"><strong class="text-primary">FP-@submission.Id @submission.Author.FullName</strong></p>
                            </div>
                        </div>
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Important:</strong> Please include the transfer content exactly as shown above for faster processing.
                        </div>
                    </div>
                </div>

                <!-- QR Code Card -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>QR Code for Transfer</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=FP-@submission.Id @submission.Author.FullName 2000000" 
                                 alt="QR Code" 
                                 class="img-fluid border rounded p-3 bg-white"
                                 style="max-width: 300px;">
                        </div>
                        <p class="text-muted small mb-0">Scan this QR code with your banking app to transfer</p>
                    </div>
                </div>

                <!-- Test Payment Button (for testing) -->
                <div class="card shadow-sm border-0 mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Test Mode</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Testing Mode:</strong> Click the button below to simulate payment confirmation without actual bank transfer.
                        </p>
                        <div class="d-grid">
                            <button type="button" class="btn btn-warning btn-lg" id="testPaymentBtn">
                                <i class="fas fa-check-circle me-2"></i>Confirm Payment (Test Mode)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="fas fa-list-ol me-2 text-primary"></i>Payment Instructions</h6>
                        <ol class="mb-0 small text-muted">
                            <li>Transfer the exact amount: <strong>2,000,000 VNĐ</strong></li>
                            <li>Include the transfer content: <strong>FP-@submission.Id @submission.Author.FullName</strong></li>
                            <li>After transferring, click "Confirm Payment (Test Mode)" button above</li>
                            <li>Or wait for admin to confirm your payment manually</li>
                            <li>Once confirmed, you will be redirected to the full paper submission page</li>
                        </ol>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('testPaymentBtn')?.addEventListener('click', function() {
            if (!confirm('Are you sure you want to confirm payment? This will allow you to proceed to full paper submission.')) {
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            const antiforgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            fetch('@Url.Action("ConfirmPayment", "Submission")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': antiforgeryToken
                },
                body: `id=@submissionId&__RequestVerificationToken=${antiforgeryToken}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = data.redirectUrl;
                } else {
                    alert(data.message || 'Payment confirmation failed. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Confirm Payment (Test Mode)';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Confirm Payment (Test Mode)';
            });
        });
    </script>
}

